<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanobot Dashboard v0.1.4.post1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Source+Sans+3:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #faf9ff;
            --bg-surface: #ffffff;
            --bg-elevated: #ffffff;
            --bg-subtle: #f5f3ff;
            --bg-hover: #ede9fe;
            --primary-900: #4c1d95;
            --primary-800: #5b21b6;
            --primary-700: #6d28d9;
            --primary-600: #7c3aed;
            --primary-500: #8b5cf6;
            --primary-400: #a78bfa;
            --primary-300: #c4b5fd;
            --primary-200: #ddd6fe;
            --primary-100: #ede9fe;
            --primary-50: #f5f3ff;
            --text-primary: #1e1b4b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --success: #059669;
            --success-bg: #ecfdf5;
            --warning: #d97706;
            --warning-bg: #fffbeb;
            --info: #2563eb;
            --info-bg: #eff6ff;
            --danger: #dc2626;
            --danger-bg: #fef2f2;
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
            --shadow-focus: 0 0 0 3px rgba(139,92,246,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'DM Sans', sans-serif;
        }

        code, .code, .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .dashboard {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-logo {
            padding: 20px 24px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, var(--primary-600), var(--primary-400)) 1;
        }

        .sidebar-logo h1 {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .sidebar-logo .version {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 0 24px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-subtle);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-subtle);
            color: var(--primary-700);
            border-left-color: var(--primary-600);
        }

        .nav-item-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
        }

        .nav-item-count {
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-subtle);
            color: var(--primary-700);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .nav-item.active .nav-item-count {
            background: var(--primary-100);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Topbar */
        .topbar {
            height: 56px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .topbar-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .topbar-title h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .breadcrumb {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Stat Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .stat-card.accent-primary {
            border-left: 4px solid var(--primary-600);
        }

        .stat-card.accent-success {
            border-left: 4px solid var(--success);
        }

        .stat-card.accent-info {
            border-left: 4px solid var(--info);
        }

        .stat-card.accent-warning {
            border-left: 4px solid var(--warning);
        }

        .stat-card-decoration {
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.05;
        }

        .stat-card.accent-primary .stat-card-decoration {
            background: var(--primary-600);
        }

        .stat-card.accent-success .stat-card-decoration {
            background: var(--success);
        }

        .stat-card.accent-info .stat-card-decoration {
            background: var(--info);
        }

        .stat-card.accent-warning .stat-card-decoration {
            background: var(--warning);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-family: 'Source Sans 3', sans-serif;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-700), var(--primary-600));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-800), var(--primary-700));
        }

        .btn-secondary {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-subtle);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 24px;
            background: #cbd5e1;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
        }

        .toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }

        .toggle.active .toggle-knob {
            transform: translateX(20px);
        }

        /* Provider Grid */
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .provider-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .provider-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .provider-card.enabled {
            border-left: 4px solid;
        }

        .provider-card.enabled.color-primary {
            border-left-color: var(--primary-600);
        }

        .provider-card.enabled.color-success {
            border-left-color: var(--success);
        }

        .provider-card.enabled.color-info {
            border-left-color: var(--info);
        }

        .provider-card.enabled.color-warning {
            border-left-color: var(--warning);
        }

        .provider-card.enabled.color-danger {
            border-left-color: var(--danger);
        }

        .provider-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .provider-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .provider-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
        }

        .provider-icon.color-primary {
            background: var(--primary-600);
        }

        .provider-icon.color-success {
            background: var(--success);
        }

        .provider-icon.color-info {
            background: var(--info);
        }

        .provider-icon.color-warning {
            background: var(--warning);
        }

        .provider-icon.color-danger {
            background: var(--danger);
        }

        .provider-name-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .provider-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .provider-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .provider-config {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
            animation: slideDown 0.2s;
        }

        .provider-card.enabled .provider-config {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .provider-note {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 12px;
            font-style: italic;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-success {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .badge-info {
            background: var(--info-bg);
            color: var(--info);
        }

        .badge-new {
            background: #059669;
            color: white;
            animation: pulse 2s infinite;
        }

        .badge-primary {
            background: var(--primary-600);
            color: white;
        }

        .badge-gray {
            background: #f1f5f9;
            color: #475569;
        }

        .badge-danger {
            background: var(--danger-bg);
            color: var(--danger);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            font-family: 'Source Sans 3', sans-serif;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: var(--shadow-focus);
        }

        .form-input.mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-checkbox label {
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-600);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-600);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary-700);
            min-width: 40px;
            text-align: right;
        }

        /* Channel Cards */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .channel-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .channel-card:hover {
            box-shadow: var(--shadow-md);
        }

        .channel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .channel-icon {
            font-size: 24px;
        }

        .channel-details h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .channel-details p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .channel-config {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            animation: slideDown 0.2s;
        }

        .channel-card.enabled .channel-config {
            display: block;
        }

        /* Tool Grid */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .tool-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .tool-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .tool-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .tool-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .tool-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .tool-config {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
            animation: slideDown 0.2s;
        }

        .tool-card.enabled .tool-config {
            display: block;
        }

        /* JSON Preview */
        .json-preview {
            background: #1e1b4b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .json-key {
            color: #a78bfa;
        }

        .json-string {
            color: #34d399;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #60a5fa;
        }

        .json-null {
            color: #94a3b8;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 0;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 24px;
        }

        .search-bar input {
            width: 100%;
            padding: 14px 14px 14px 44px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            font-size: 14px;
            box-shadow: var(--shadow-sm);
        }

        .search-bar input:focus {
            outline: none;
            box-shadow: var(--shadow-focus);
            border-color: var(--primary-600);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Code Block */
        .code-block {
            background: #1e1b4b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .code-inline {
            background: var(--primary-50);
            color: var(--primary-800);
            padding: 2px 6px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .activity-item:hover {
            background: var(--bg-subtle);
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 60px;
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Changelog */
        .changelog-section {
            margin-bottom: 32px;
        }

        .changelog-section h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .changelog-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .changelog-bullet {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .changelog-bullet.success {
            background: var(--success);
        }

        .changelog-bullet.info {
            background: var(--info);
        }

        .changelog-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .changelog-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Modal */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--bg-surface);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.2s;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--bg-surface);
            border-left: 4px solid var(--success);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-message {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-surface);
        }

        .table thead {
            background: var(--bg-subtle);
        }

        .table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
        }

        .table td {
            padding: 16px;
            border-top: 1px solid var(--border-light);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .table tbody tr:hover {
            background: var(--bg-subtle);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        /* Two Column Layout */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .agent-config-layout {
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 32px;
        }

        /* Highlights List */
        .highlights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .highlight-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .highlight-icon {
            color: var(--success);
            font-size: 18px;
            margin-top: 2px;
        }

        .highlight-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* CLI Commands */
        .cli-commands {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cli-command {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .cli-command code {
            font-size: 13px;
            color: var(--primary-800);
        }

        /* Subagent Cards */
        .subagent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .subagent-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .subagent-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .subagent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .subagent-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .subagent-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.running {
            animation: pulse 2s infinite;
        }

        .subagent-task {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-500));
            transition: width 0.3s;
        }

        .subagent-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        .chat-header {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .chat-header .form-group {
            margin-bottom: 0;
            flex: 1;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--success-bg);
            color: var(--success);
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.system {
            max-width: 100%;
            background: var(--bg-subtle);
            color: var(--text-muted);
            text-align: center;
            font-size: 13px;
            font-style: italic;
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            color: white;
        }

        .chat-message.agent {
            align-self: flex-start;
            background: var(--bg-subtle);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
        }

        .chat-input-area .form-input {
            flex: 1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Utilities */
        .mb-32 {
            margin-bottom: 32px;
        }

        .mb-24 {
            margin-bottom: 24px;
        }

        .mb-16 {
            margin-bottom: 16px;
        }

        .mt-16 {
            margin-top: 16px;
        }

        .flex {
            display: flex;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gap-12 {
            gap: 12px;
        }

        .gap-16 {
            gap: 16px;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 150px;
        }

        .info-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .page-header p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .page-actions {
            display: flex;
            gap: 12px;
        }

        .whatsapp-qr-button {
            margin-top: 12px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-subtle);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--text-muted); }
        .connection-status.online { color: var(--success); }
        .connection-status.online .status-dot { background: var(--success); box-shadow: 0 0 6px var(--success); }

        /* Setup Wizard Overlay */
        .setup-wizard-overlay {
            position: fixed;
            inset: 0;
            background: rgba(30, 27, 75, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .setup-wizard-overlay.hidden { display: none; }
        .setup-wizard {
            background: var(--bg-surface);
            border-radius: 20px;
            padding: 48px;
            max-width: 560px;
            width: 90%;
            box-shadow: var(--shadow-xl), 0 0 60px rgba(109, 40, 217, 0.15);
            text-align: center;
        }
        .setup-wizard h2 {
            font-family: 'DM Sans', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .setup-wizard .setup-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .setup-wizard .setup-field {
            text-align: left;
            margin-bottom: 20px;
        }
        .setup-wizard .setup-field label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .setup-wizard .setup-field input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            transition: border-color 0.2s;
            box-sizing: border-box;
            background: var(--bg-base);
        }
        .setup-wizard .setup-field input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: var(--shadow-focus);
        }
        .setup-wizard .setup-field .field-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .setup-wizard .setup-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }
        .setup-wizard .setup-actions .btn { flex: 1; padding: 14px; font-size: 15px; }
        .setup-wizard .setup-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 12px;
        }
        .setup-wizard .setup-divider::before,
        .setup-wizard .setup-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .setup-wizard .provider-quick-pick {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        .setup-wizard .provider-pill {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-base);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .setup-wizard .provider-pill:hover {
            border-color: var(--primary-400);
            background: var(--primary-50);
        }
        .setup-wizard .provider-pill.selected {
            border-color: var(--primary-600);
            background: var(--primary-100);
            color: var(--primary-800);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-logo">
                <h1>Nanobot</h1>
                <div class="version">v0.1.4.post1 by HKUDS</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-label">Dashboard</div>
                    <div class="nav-item active" data-page="overview" onclick="navigate('overview', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üìä</span>
                            <span>Overview</span>
                        </div>
                    </div>
                    <div class="nav-item" data-page="agent" onclick="navigate('agent', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">‚öôÔ∏è</span>
                            <span>Agent Config</span>
                        </div>
                    </div>
                </div>
                <div class="nav-section" data-section="configuration">
                    <div class="nav-section-label">Configuration</div>
                    <div class="nav-item" data-page="providers" onclick="navigate('providers', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">ü§ñ</span>
                            <span>Providers</span>
                        </div>
                        <span class="nav-item-count" id="providerCount">15</span>
                    </div>
                    <div class="nav-item" data-page="channels" onclick="navigate('channels', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üí¨</span>
                            <span>Channels</span>
                        </div>
                        <span class="nav-item-count" id="channelCount">10</span>
                    </div>
                    <div class="nav-item" data-page="tools" onclick="navigate('tools', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üîß</span>
                            <span>Tools</span>
                        </div>
                    </div>
                    <div class="nav-item" data-page="skills" onclick="navigate('skills', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">‚ú®</span>
                            <span>Skills</span>
                        </div>
                    </div>
                </div>
                <div class="nav-section" data-section="advanced">
                    <div class="nav-section-label">Advanced</div>
                    <div class="nav-item" data-page="memory" onclick="navigate('memory', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üß†</span>
                            <span>Memory</span>
                        </div>
                    </div>
                    <div class="nav-item" data-page="cron" onclick="navigate('cron', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">‚è∞</span>
                            <span>Cron Jobs</span>
                        </div>
                    </div>
                    <div class="nav-item" data-page="subagents" onclick="navigate('subagents', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üë•</span>
                            <span>Subagents</span>
                        </div>
                    </div>
                </div>
                <div class="nav-section" data-section="other">
                    <div class="nav-section-label">Other</div>
                    <div class="nav-item" data-page="chat" onclick="navigate('chat', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üí≠</span>
                            <span>Chat</span>
                        </div>
                    </div>
                    <div class="nav-item" data-page="changelog" onclick="navigate('changelog', this)">
                        <div class="nav-item-label">
                            <span class="nav-item-icon">üìù</span>
                            <span>Changelog</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="topbar-title">
                    <h2 id="pageTitle">Overview</h2>
                </div>
                <div id="connectionStatus" class="connection-status">
                    <span class="status-dot offline"></span>
                    <span class="status-text">Offline</span>
                </div>
                <div class="page-actions">
                    <button class="btn btn-primary" onclick="saveAllToBackend()" id="btnSaveAll" title="Save everything to ~/.nanobot/config.json">
                        Save Config
                    </button>
                    <label class="btn btn-secondary" style="cursor:pointer">
                        Import
                        <input type="file" accept=".json" style="display:none" onchange="importConfig(event)">
                    </label>
                    <button class="btn btn-secondary" onclick="exportConfig()">
                        Export
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Overview Page -->
                <div id="overview" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card accent-primary">
                            <div class="stat-card-decoration"></div>
                            <div class="stat-label">Providers</div>
                            <div class="stat-value" id="statProviders">0/15</div>
                        </div>
                        <div class="stat-card accent-success">
                            <div class="stat-card-decoration"></div>
                            <div class="stat-label">Channels</div>
                            <div class="stat-value" id="statChannels">1/10</div>
                        </div>
                        <div class="stat-card accent-info">
                            <div class="stat-card-decoration"></div>
                            <div class="stat-label">Tools</div>
                            <div class="stat-value" id="statTools">0/6</div>
                        </div>
                        <div class="stat-card accent-warning">
                            <div class="stat-card-decoration"></div>
                            <div class="stat-label">Skills</div>
                            <div class="stat-value" id="statSkills">3</div>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Agent Information</h3>
                                <p class="card-subtitle">Current configuration</p>
                            </div>
                            <div class="info-grid">
                                <div class="info-row">
                                    <div class="info-label">Agent Name</div>
                                    <div class="info-value">nanobot-assistant</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Model</div>
                                    <div class="info-value">claude-opus-4-6</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Provider</div>
                                    <div class="info-value">anthropic</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Max Iterations</div>
                                    <div class="info-value">15</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Workspace</div>
                                    <div class="info-value">/workspace/nanobot</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">v0.1.4.post1 Highlights</h3>
                                <p class="card-subtitle">Latest improvements</p>
                            </div>
                            <div class="highlights-list">
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">Feishu media support with WebSocket</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">Slack media upload capabilities</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">Discord auto-split for long messages</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">VolcEngine provider integration</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">Prompt caching for Anthropic & OpenRouter</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">31% faster agent loop processing</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">Structured memory consolidation</span>
                                </div>
                                <div class="highlight-item">
                                    <span class="highlight-icon">‚úì</span>
                                    <span class="highlight-text">MCP server auth headers support</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Activity Feed</h3>
                                <p class="card-subtitle">Recent events</p>
                            </div>
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <div class="activity-time">14:32</div>
                                    <div class="activity-content">
                                        <span class="badge badge-success">System</span>
                                        <span class="activity-message">Dashboard initialized</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">14:30</div>
                                    <div class="activity-content">
                                        <span class="badge badge-info">Channel</span>
                                        <span class="activity-message">CLI channel active</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">14:28</div>
                                    <div class="activity-content">
                                        <span class="badge badge-warning">Config</span>
                                        <span class="activity-message">Configuration loaded</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">14:25</div>
                                    <div class="activity-content">
                                        <span class="badge badge-success">Memory</span>
                                        <span class="activity-message">Memory system ready</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">14:20</div>
                                    <div class="activity-content">
                                        <span class="badge badge-info">Skills</span>
                                        <span class="activity-message">3 skills loaded</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">14:15</div>
                                    <div class="activity-content">
                                        <span class="badge badge-success">System</span>
                                        <span class="activity-message">Agent started</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">CLI Commands</h3>
                                <p class="card-subtitle">Quick reference</p>
                            </div>
                            <div class="cli-commands">
                                <div class="cli-command">
                                    <code>nanobot onboard</code>
                                </div>
                                <div class="cli-command">
                                    <code>nanobot agent</code>
                                </div>
                                <div class="cli-command">
                                    <code>nanobot gateway</code>
                                </div>
                                <div class="cli-command">
                                    <code>nanobot channels login [channel]</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Config Page -->
                <div id="agent" class="page">
                    <div class="agent-config-layout">
                        <div>
                            <div class="card mb-24">
                                <div class="card-header">
                                    <h3 class="card-title">Identity</h3>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agent Name</label>
                                    <input type="text" class="form-input mono" id="agentName" value="nanobot-assistant" oninput="syncConfig()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Version</label>
                                    <input type="text" class="form-input mono" id="agentVersion" value="1.0.0" oninput="syncConfig()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Workspace Path</label>
                                    <input type="text" class="form-input mono" id="agentWorkspace" value="/workspace/nanobot" oninput="syncConfig()">
                                </div>
                            </div>

                            <div class="card mb-24">
                                <div class="card-header">
                                    <h3 class="card-title">Agent Defaults</h3>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Provider</label>
                                    <select class="form-select" id="agentProvider" onchange="onProviderChange()">
                                        <option value="openrouter">OpenRouter</option>
                                        <option value="anthropic" selected>Anthropic</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="gemini">Gemini</option>
                                        <option value="groq">Groq</option>
                                        <option value="aihubmix">AiHubMix</option>
                                        <option value="siliconflow">SiliconFlow</option>
                                        <option value="volcengine">VolcEngine</option>
                                        <option value="dashscope">DashScope</option>
                                        <option value="zhipu">Zhipu</option>
                                        <option value="moonshot">Moonshot</option>
                                        <option value="minimax">MiniMax</option>
                                        <option value="vllm">vLLM</option>
                                        <option value="openai_codex">OpenAI Codex (OAuth)</option>
                                        <option value="github_copilot">GitHub Copilot (OAuth)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Model</label>
                                    <div class="model-combo" id="modelCombo" style="position:relative;">
                                        <input type="text" class="form-input mono" id="agentModel" placeholder="Type or select a model..." autocomplete="off" oninput="onModelInput()" onfocus="showModelDropdown()" onchange="syncConfig()">
                                        <div id="modelDropdown" class="model-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:240px;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;box-shadow:var(--shadow-md);z-index:100;"></div>
                                        <div id="modelLoading" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-muted);">Loading...</div>
                                    </div>
                                    <div class="field-hint" style="font-size:11px;color:var(--text-muted);margin-top:4px;" id="modelHint">Select a provider to see available models, or type any model name.</div>
                                </div>
                            </div>

                            <div class="card mb-24">
                                <div class="card-header">
                                    <h3 class="card-title">Parameters</h3>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Temperature</label>
                                    <div class="slider-container">
                                        <input type="range" class="slider" id="agentTemperature" min="0" max="2" step="0.05" value="0.7" oninput="updateSlider(this); syncConfig()">
                                        <span class="slider-value" id="tempValue">0.7</span>
                                    </div>
                                </div>
                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Max Tokens</label>
                                        <input type="number" class="form-input" id="agentMaxTokens" value="4096" oninput="syncConfig()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max Iterations</label>
                                        <input type="number" class="form-input" id="agentMaxIterations" value="15" oninput="syncConfig()">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Memory Window</label>
                                    <input type="number" class="form-input" id="agentMemoryWindow" value="10" oninput="syncConfig()">
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">System Prompt</h3>
                                </div>
                                <div class="form-group">
                                    <textarea class="form-textarea" id="agentSystemPrompt" rows="8" oninput="syncConfig()">You are Nanobot, an AI agent framework assistant. You help users configure and manage their AI agents, channels, tools, and workflows. Be helpful, concise, and technical when needed.</textarea>
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button class="btn btn-primary" onclick="saveAgentConfigToBackend()">Save to config.json</button>
                                    <button class="btn btn-secondary" onclick="restartAgent()">Restart Agent</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div style="position: sticky; top: 20px;">
                                <div class="card mb-16">
                                    <div class="flex-between mb-16">
                                        <h3 class="card-title">JSON Preview</h3>
                                        <div class="flex gap-12">
                                            <button class="btn btn-small btn-secondary" onclick="copyConfig()">Copy</button>
                                            <button class="btn btn-small btn-primary" onclick="exportConfig()">Export</button>
                                        </div>
                                    </div>
                                    <div class="json-preview" id="configPreview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Providers Page -->
                <div id="providers" class="page">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" placeholder="Search providers..." oninput="filterProviders(this.value)">
                    </div>
                    <div class="provider-grid" id="providerGrid"></div>
                </div>

                <!-- Channels Page -->
                <div id="channels" class="page">
                    <div class="channel-list" id="channelList"></div>
                </div>

                <!-- Tools Page -->
                <div id="tools" class="page">
                    <div class="tool-grid" id="toolGrid"></div>
                </div>

                <!-- Skills Page -->
                <div id="skills" class="page">
                    <div class="page-header">
                        <div>
                            <h2>Skills</h2>
                            <p>Extend your agent with custom capabilities</p>
                        </div>
                        <div id="connectionStatus" class="connection-status">
                    <span class="status-dot offline"></span>
                    <span class="status-text">Offline</span>
                </div>
                <div class="page-actions">
                            <button class="btn btn-secondary" onclick="window.open('https://github.com/HKUDS/ClawHub', '_blank')">
                                üõí ClawHub Marketplace
                            </button>
                            <button class="btn btn-primary" onclick="openModal('addSkillModal')">
                                ‚ûï Add Skill
                            </button>
                        </div>
                    </div>

                    <div class="card mb-24">
                        <div class="card-header">
                            <h3 class="card-title">Install from ClawHub</h3>
                        </div>
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Search ClawHub</label>
                                <input type="text" class="form-input" placeholder="e.g., code-review, data-analysis">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Install from URL</label>
                                <input type="text" class="form-input mono" placeholder="https://github.com/user/skill.git">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Summary</th>
                                        <th>Enabled</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="skillsTable">
                                    <tr>
                                        <td><strong>web-search</strong></td>
                                        <td>Search the web using various engines</td>
                                        <td>
                                            <div class="toggle active">
                                                <div class="toggle-knob"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">View</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>code-review</strong></td>
                                        <td>Automated code review and suggestions</td>
                                        <td>
                                            <div class="toggle active">
                                                <div class="toggle-knob"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">View</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>data-analysis</strong></td>
                                        <td>Analyze datasets and generate insights</td>
                                        <td>
                                            <div class="toggle active">
                                                <div class="toggle-knob"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">View</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Memory Page -->
                <div id="memory" class="page">
                    <div class="card">
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('memory', 0, this)">MEMORY.md</div>
                            <div class="tab" onclick="switchTab('memory', 1, this)">HISTORY.md</div>
                            <div class="tab" onclick="switchTab('memory', 2, this)">Settings</div>
                        </div>

                        <div class="tab-content active" id="memoryTab0">
                            <div class="form-group">
                                <textarea class="form-textarea mono" id="memoryContent" rows="20" placeholder="# Agent Memory

Write important context, facts, and information here...

## User Preferences
- Response style: Technical and concise
- Code comments: Always include

## Project Context
- Framework: Nanobot v0.1.4.post1
- Language: Python 3.11+"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="saveMemory()">üíæ Save Memory</button>
                        </div>

                        <div class="tab-content" id="memoryTab1">
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="üîç Search history...">
                            </div>
                            <div class="code-block">[2026-02-22 14:32:15] User: Configure Anthropic provider
[2026-02-22 14:32:20] Agent: I'll help you configure the Anthropic provider...
[2026-02-22 14:35:42] User: Enable Telegram channel
[2026-02-22 14:35:48] Agent: Setting up Telegram channel configuration...
[2026-02-22 14:40:12] User: Add web-search skill
[2026-02-22 14:40:18] Agent: Installing web-search skill from ClawHub...</div>
                        </div>

                        <div class="tab-content" id="memoryTab2">
                            <div class="form-group">
                                <label class="form-label">Memory Window</label>
                                <input type="number" class="form-input" value="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Consolidation Method</label>
                                <select class="form-select">
                                    <option selected>Structured Tool Calls (Recommended)</option>
                                    <option>JSON Parsing (Legacy)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary">Save Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Cron Jobs Page -->
                <div id="cron" class="page">
                    <div class="page-header">
                        <div>
                            <h2>Cron Jobs</h2>
                            <p>Scheduled tasks and automation</p>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('addCronModal')">
                            ‚ûï Add Job
                        </button>
                    </div>

                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Schedule</th>
                                        <th>Task</th>
                                        <th>Status</th>
                                        <th>Last Run</th>
                                        <th>Next Run</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cronTable">
                                    <tr>
                                        <td><span class="code-inline">job_001</span></td>
                                        <td><span class="code-inline">0 9 * * *</span></td>
                                        <td>Daily summary report</td>
                                        <td><span class="badge badge-success">Active</span></td>
                                        <td>2026-02-22 09:00</td>
                                        <td>2026-02-23 09:00</td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">Edit</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><span class="code-inline">job_002</span></td>
                                        <td><span class="code-inline">*/30 * * * *</span></td>
                                        <td>Check system health</td>
                                        <td><span class="badge badge-success">Active</span></td>
                                        <td>2026-02-22 14:00</td>
                                        <td>2026-02-22 14:30</td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">Edit</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><span class="code-inline">job_003</span></td>
                                        <td><span class="code-inline">0 0 * * 0</span></td>
                                        <td>Weekly backup</td>
                                        <td><span class="badge badge-warning">Paused</span></td>
                                        <td>2026-02-16 00:00</td>
                                        <td>2026-02-23 00:00</td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="btn btn-small btn-secondary">Edit</button>
                                                <button class="btn btn-small btn-secondary">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Subagents Page -->
                <div id="subagents" class="page">
                    <div class="page-header">
                        <div>
                            <h2>Subagents Monitor</h2>
                            <p>Active and completed subagent tasks</p>
                        </div>
                    </div>

                    <div class="subagent-grid">
                        <div class="subagent-card">
                            <div class="subagent-header">
                                <div class="subagent-name">data-processor-01</div>
                                <div class="subagent-status">
                                    <div class="status-indicator running"></div>
                                    <span class="badge badge-success">Running</span>
                                </div>
                            </div>
                            <div class="subagent-task">Processing CSV dataset with 50,000 rows</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 65%"></div>
                            </div>
                            <div class="subagent-meta">Iteration 7/15 ‚Ä¢ Started 2 min ago</div>
                        </div>

                        <div class="subagent-card">
                            <div class="subagent-header">
                                <div class="subagent-name">code-reviewer-02</div>
                                <div class="subagent-status">
                                    <div class="status-indicator running"></div>
                                    <span class="badge badge-success">Running</span>
                                </div>
                            </div>
                            <div class="subagent-task">Reviewing pull request #342 changes</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 40%"></div>
                            </div>
                            <div class="subagent-meta">Iteration 4/15 ‚Ä¢ Started 5 min ago</div>
                        </div>

                        <div class="subagent-card">
                            <div class="subagent-header">
                                <div class="subagent-name">web-scraper-03</div>
                                <div class="subagent-status">
                                    <div class="status-indicator"></div>
                                    <span class="badge badge-gray">Completed</span>
                                </div>
                            </div>
                            <div class="subagent-task">Scraped 250 product listings from target site</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 100%"></div>
                            </div>
                            <div class="subagent-meta">Iteration 12/15 ‚Ä¢ Completed 10 min ago</div>
                        </div>

                        <div class="subagent-card">
                            <div class="subagent-header">
                                <div class="subagent-name">api-tester-04</div>
                                <div class="subagent-status">
                                    <div class="status-indicator"></div>
                                    <span class="badge badge-gray">Completed</span>
                                </div>
                            </div>
                            <div class="subagent-task">Tested 45 API endpoints for authentication</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 100%"></div>
                            </div>
                            <div class="subagent-meta">Iteration 9/15 ‚Ä¢ Completed 25 min ago</div>
                        </div>
                    </div>
                </div>

                <!-- Changelog Page -->
                <div id="changelog" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Release v0.1.4.post1</h3>
                            <p class="card-subtitle">Latest updates and improvements</p>
                        </div>

                        <div class="changelog-section">
                            <h3>New Features</h3>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Feishu Media Support:</strong> Full media upload/download with WebSocket integration
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Slack Media Upload:</strong> Native file upload capabilities for Slack channel
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Discord Long Messages:</strong> Auto-split messages over 2000 characters
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>VolcEngine Provider:</strong> Added support for VolcEngine/Doubao models
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Prompt Caching:</strong> Enabled for Anthropic and OpenRouter providers
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>MCP Auth Headers:</strong> Support for custom authentication headers in MCP servers
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Telegram Improvements:</strong> Configurable reply-to behavior, /help command bypasses ACL
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>CLI Subagent Spawn:</strong> Spawn subagents directly from CLI interface
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet success"></div>
                                <div class="changelog-content">
                                    <strong>Smarter File Editing:</strong> Improved file edit detection and patch application
                                </div>
                            </div>
                        </div>

                        <div class="changelog-section">
                            <h3>Fixes & Improvements</h3>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Structured Memory:</strong> Memory consolidation now uses structured tool calls instead of JSON parsing
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>31% Faster Agent Loop:</strong> Optimized message processing and state management
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>MCP Reconnection:</strong> Fixed race condition in MCP server reconnection logic
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Session Key Persistence:</strong> Session keys now properly persist across restarts
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Duplicate Reply Prevention:</strong> Fixed duplicate message replies in Telegram
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Cron Reliability:</strong> Improved cron job execution reliability and error handling
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Codex Provider Routing:</strong> Fixed model routing for DeepSeek Codex models
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Shell Timeout Cleanup:</strong> Proper cleanup of timed-out shell processes
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Safety Guard Fixes:</strong> Improved ACL and permission checks
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>UTF-8 Encoding:</strong> Fixed encoding issues in file operations
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Relative Path Resolution:</strong> Better handling of relative paths in tools
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Timezone Validation:</strong> Added validation for cron job timezone settings
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Memory Consolidation Schema:</strong> Improved schema validation for memory operations
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Interim Retry Logic:</strong> Better retry handling for transient failures
                                </div>
                            </div>
                            <div class="changelog-item">
                                <div class="changelog-bullet info"></div>
                                <div class="changelog-content">
                                    <strong>Non-string Value Handling:</strong> Fixed handling of non-string values in tool responses
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Page -->
                <div id="chat" class="page">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="form-group">
                                <label class="form-label">Provider</label>
                                <select class="form-select" id="chatProvider" onchange="onChatProviderChange()">
                                    <option value="openrouter">OpenRouter</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="groq">Groq</option>
                                    <option value="aihubmix">AiHubMix</option>
                                    <option value="siliconflow">SiliconFlow</option>
                                    <option value="volcengine">VolcEngine</option>
                                    <option value="dashscope">DashScope</option>
                                    <option value="zhipu">Zhipu</option>
                                    <option value="moonshot">Moonshot</option>
                                    <option value="minimax">MiniMax</option>
                                    <option value="vllm">vLLM</option>
                                    <option value="openai_codex">OpenAI Codex</option>
                                    <option value="github_copilot">GitHub Copilot</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group" style="position:relative;flex:1;min-width:0;">
                                <label class="form-label">Model</label>
                                <div style="position:relative;">
                                    <input type="text" class="form-input mono" id="chatModel" placeholder="Type or select a model..." autocomplete="off" oninput="onChatModelInput()" onfocus="showChatModelDropdown()">
                                    <div id="chatModelDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:220px;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;box-shadow:var(--shadow-md);z-index:200;"></div>
                                    <div id="chatModelLoading" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--text-muted);">Loading...</div>
                                </div>
                                <div id="chatModelHint" style="font-size:11px;color:var(--text-muted);margin-top:3px;"></div>
                            </div>
                            <div class="chat-status">
                                <span>‚óè</span> Connected
                            </div>
                        </div>

                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message system">
                                Chat session started. Type a message to begin.
                            </div>
                            <div class="chat-message agent">
                                Hello! I'm your Nanobot assistant. How can I help you today?
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <input type="text" class="form-input" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendChat()">
                            <button class="btn btn-primary" onclick="sendChat()">Send</button>
                            <button class="btn btn-secondary" onclick="clearChat()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Add Skill Modal -->
    <div class="modal-backdrop" id="addSkillModal" onclick="if(event.target === this) closeModal('addSkillModal')">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Skill</h3>
            </div>
            <div class="form-group">
                <label class="form-label">Skill Name</label>
                <input type="text" class="form-input" id="newSkillName" placeholder="e.g., image-generator">
            </div>
            <div class="form-group">
                <label class="form-label">Summary</label>
                <input type="text" class="form-input" id="newSkillSummary" placeholder="Brief description of the skill">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addSkillModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addSkill()">Add Skill</button>
            </div>
        </div>
    </div>

    <!-- Add Cron Job Modal -->
    <div class="modal-backdrop" id="addCronModal" onclick="if(event.target === this) closeModal('addCronModal')">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Cron Job</h3>
            </div>
            <div class="form-group">
                <label class="form-label">Schedule (Cron Expression)</label>
                <input type="text" class="form-input mono" id="newCronSchedule" placeholder="0 */6 * * *">
            </div>
            <div class="form-group">
                <label class="form-label">Task Description</label>
                <input type="text" class="form-input" id="newCronTask" placeholder="e.g., Database cleanup">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCronModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addCronJob()">Add Job</button>
            </div>
        </div>
    </div>

    <!-- Add MCP Server Modal -->
    <div class="modal-backdrop" id="addMcpModal" onclick="if(event.target === this) closeModal('addMcpModal')">
        <div class="modal">
            <div class="modal-header">
                <h3>Add MCP Server</h3>
            </div>
            <div class="form-group">
                <label class="form-label">Server Name</label>
                <input type="text" class="form-input" id="newMcpName" placeholder="e.g., filesystem">
            </div>
            <div class="form-group">
                <label class="form-label">Command</label>
                <input type="text" class="form-input mono" id="newMcpCommand" placeholder="npx -y @modelcontextprotocol/server-filesystem">
            </div>
            <div class="form-group">
                <label class="form-label">Arguments (JSON array)</label>
                <input type="text" class="form-input mono" id="newMcpArgs" placeholder='["/workspace"]'>
            </div>
            <div class="form-group">
                <label class="form-label">Auth Header (Optional)</label>
                <input type="text" class="form-input mono" id="newMcpAuth" placeholder="Bearer token...">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMcpModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addMcpServer()">Add Server</button>
            </div>
        </div>
    </div>

    <!-- Setup Wizard (shown on first run when no API keys are configured) -->
    <div class="setup-wizard-overlay hidden" id="setupWizard">
        <div class="setup-wizard">
            <h2>Welcome to Nanobot</h2>
            <p class="setup-subtitle">
                Add an API key to get started. All settings are saved directly to <code style="background:var(--bg-subtle);padding:2px 6px;border-radius:4px;font-size:13px;">~/.nanobot/config.json</code> on your server.
            </p>

            <div class="provider-quick-pick" id="wizardProviderPick">
                <span class="provider-pill selected" data-provider="openrouter" onclick="wizardSelectProvider(this)">OpenRouter</span>
                <span class="provider-pill" data-provider="anthropic" onclick="wizardSelectProvider(this)">Anthropic</span>
                <span class="provider-pill" data-provider="openai" onclick="wizardSelectProvider(this)">OpenAI</span>
                <span class="provider-pill" data-provider="deepseek" onclick="wizardSelectProvider(this)">DeepSeek</span>
                <span class="provider-pill" data-provider="gemini" onclick="wizardSelectProvider(this)">Gemini</span>
                <span class="provider-pill" data-provider="groq" onclick="wizardSelectProvider(this)">Groq</span>
                <span class="provider-pill" data-provider="aihubmix" onclick="wizardSelectProvider(this)">AiHubMix</span>
                <span class="provider-pill" data-provider="siliconflow" onclick="wizardSelectProvider(this)">SiliconFlow</span>
                <span class="provider-pill" data-provider="volcengine" onclick="wizardSelectProvider(this)">VolcEngine</span>
                <span class="provider-pill" data-provider="dashscope" onclick="wizardSelectProvider(this)">DashScope</span>
                <span class="provider-pill" data-provider="zhipu" onclick="wizardSelectProvider(this)">Zhipu</span>
                <span class="provider-pill" data-provider="moonshot" onclick="wizardSelectProvider(this)">Moonshot</span>
                <span class="provider-pill" data-provider="minimax" onclick="wizardSelectProvider(this)">MiniMax</span>
                <span class="provider-pill" data-provider="vllm" onclick="wizardSelectProvider(this)">vLLM</span>
                <span class="provider-pill" data-provider="openai_codex" onclick="wizardSelectProvider(this)">OpenAI Codex</span>
                <span class="provider-pill" data-provider="github_copilot" onclick="wizardSelectProvider(this)">GitHub Copilot</span>
                <span class="provider-pill" data-provider="custom" onclick="wizardSelectProvider(this)">Custom</span>
            </div>

            <div class="setup-field" id="wizardBaseUrlField" style="display:none;">
                <label id="wizardBaseUrlLabel">BASE URL</label>
                <input type="text" id="wizardBaseUrl" placeholder="http://localhost:8000/v1">
                <div class="field-hint" id="wizardBaseUrlHint">URL of your OpenAI-compatible server</div>
            </div>

            <div class="setup-field" id="wizardKeyField">
                <label id="wizardKeyLabel">OPENROUTER API KEY</label>
                <input type="password" id="wizardApiKey" placeholder="sk-or-...">
                <div class="field-hint" id="wizardKeyHint">Get one at <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--primary-600)">openrouter.ai/keys</a></div>
            </div>

            <div class="setup-field" id="wizardModelField">
                <label>MODEL (optional)</label>
                <div style="position:relative;">
                    <input type="text" id="wizardModel" placeholder="Leave blank for default..." autocomplete="off" oninput="onWizardModelInput()" onfocus="showWizardModelDropdown()" style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;box-sizing:border-box;">
                    <div id="wizardModelDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;box-shadow:var(--shadow-md);z-index:300;"></div>
                </div>
                <div class="field-hint">Leave blank for default. Change later in Agent Config.</div>
            </div>

            <div id="wizardOAuthFlow" style="display:none;">
                <div class="setup-field">
                    <label id="wizardOAuthLabel">OAUTH LOGIN</label>
                    <div id="wizardOAuthStatus" style="padding:12px;border-radius:8px;background:var(--bg-subtle);margin-bottom:8px;font-size:13px;line-height:1.6;">
                        Click "Start Login" to begin the OAuth authentication flow.
                    </div>
                    <div id="wizardOAuthCodeField" style="display:none;">
                        <label style="font-size:11px;font-weight:600;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px;display:block;">PASTE CALLBACK URL OR CODE</label>
                        <input type="text" id="wizardOAuthCode" placeholder="Paste the callback URL or authorization code here..." style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:13px;">
                    </div>
                </div>
            </div>

            <div class="setup-actions">
                <button class="btn btn-secondary" onclick="dismissWizard()">Skip</button>
                <button class="btn btn-primary" id="wizardOAuthStartBtn" style="display:none;" onclick="startOAuthFromWizard()">Start Login</button>
                <button class="btn btn-primary" id="wizardOAuthSubmitBtn" style="display:none;" onclick="submitOAuthFromWizard()">Submit Code</button>
                <button class="btn btn-primary" id="wizardSaveBtn" onclick="completeWizard()">Save & Start</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // NANOBOT DASHBOARD ‚Äî FULLY MODIFIABLE API-DRIVEN ENGINE
        // ============================================================
        // All data is mutable at runtime. The bot (or any script) can
        // call window.NanobotDashboard.* to add/remove/update providers,
        // channels, tools, skills, cron jobs, MCP servers, subagents,
        // custom pages, nav items, and more. All changes persist to
        // localStorage and fire custom events.
        // ============================================================

        // --- Core State ---
        const state = {
            providers: {},      // { id: { enabled, fields: {fieldName: value}, promptCaching } }
            channels: {},       // { id: { enabled, fields: {fieldName: value}, allowFrom, groupPolicy } }
            tools: {},          // { id: { enabled, fields: {fieldName: value} } }
            skills: [],         // [{ name, summary, enabled, content }]
            cronJobs: [],       // [{ id, schedule, task, active }]
            mcpServers: [],     // [{ name, command, args, authHeader }]
            subagents: [],      // [{ name, task, status, iteration, maxIterations }]
            agentConfig: {
                name: 'nanobot-assistant',
                version: '0.1.4.post1',
                workspace: '/workspace/nanobot',
                model: 'claude-opus-4-6',
                provider: 'anthropic',
                temperature: 0.7,
                max_tokens: 4096,
                max_iterations: 15,
                memory_window: 10,
                system_prompt: 'You are Nanobot, an AI agent framework designed to help developers build and deploy intelligent agents.'
            },
            memory: '',
            customPages: {},    // { pageId: { title, html } }
            activityLog: []     // [{ time, badge, badgeClass, message }]
        };

        // --- Backend API Client ---
        const NanobotAPI = {
            baseUrl: '',  // same origin
            connected: false,
            ws: null,
            eventsWs: null,

            async fetch(path, opts = {}) {
                try {
                    const res = await fetch(this.baseUrl + path, {
                        headers: { 'Content-Type': 'application/json', ...opts.headers },
                        ...opts,
                    });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        const errMsg = err.error || `HTTP ${res.status}`;
                        console.error('API error:', path, errMsg);
                        if (res.status === 401) {
                            // Redirect to login on auth failure
                            window.location.href = '/api/auth/login';
                            return null;
                        }
                        toast('API error: ' + errMsg);
                        throw new Error(errMsg);
                    }
                    return await res.json();
                } catch (e) {
                    console.warn('API call failed:', path, e.message);
                    return null;
                }
            },

            async loadConfig() {
                const data = await this.fetch('/api/config');
                if (!data) return false;
                this.connected = true;
                applyBackendConfig(data);
                return true;
            },

            async saveProviderConfig(name, config) {
                return await this.fetch(`/api/providers/${name}`, {
                    method: 'PUT',
                    body: JSON.stringify(config),
                });
            },

            async saveChannelConfig(name, config) {
                return await this.fetch(`/api/channels/${name}`, {
                    method: 'PUT',
                    body: JSON.stringify(config),
                });
            },

            async saveAgentConfig(config) {
                return await this.fetch('/api/agent', {
                    method: 'PUT',
                    body: JSON.stringify(config),
                });
            },

            async saveToolsConfig(config) {
                return await this.fetch('/api/tools', {
                    method: 'PUT',
                    body: JSON.stringify(config),
                });
            },

            async saveMcpServer(name, config) {
                return await this.fetch(`/api/tools/mcp/${name}`, {
                    method: 'PUT',
                    body: JSON.stringify(config),
                });
            },

            async deleteMcpServer(name) {
                return await this.fetch(`/api/tools/mcp/${name}`, { method: 'DELETE' });
            },

            async loadSkills() {
                return await this.fetch('/api/skills');
            },

            async saveSkill(name, content) {
                return await this.fetch(`/api/skills/${name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content }),
                });
            },

            async deleteSkill(name) {
                return await this.fetch(`/api/skills/${name}`, { method: 'DELETE' });
            },

            async loadMemory() {
                return await this.fetch('/api/memory');
            },

            async saveMemory(content) {
                return await this.fetch('/api/memory', {
                    method: 'PUT',
                    body: JSON.stringify({ memory: content }),
                });
            },

            async loadCronJobs() {
                return await this.fetch('/api/cron');
            },

            async addCronJob(job) {
                return await this.fetch('/api/cron', {
                    method: 'POST',
                    body: JSON.stringify(job),
                });
            },

            async deleteCronJob(id) {
                return await this.fetch(`/api/cron/${id}`, { method: 'DELETE' });
            },

            async toggleCronJob(id, enabled) {
                return await this.fetch(`/api/cron/${id}/toggle`, {
                    method: 'POST',
                    body: JSON.stringify({ enabled }),
                });
            },

            async getStatus() {
                return await this.fetch('/api/status');
            },

            async patchConfig(updates) {
                return await this.fetch('/api/config', {
                    method: 'PATCH',
                    body: JSON.stringify(updates),
                });
            },

            async restartAgent() {
                return await this.fetch('/api/agent/restart', { method: 'POST' });
            },

            async loadExtensions() {
                return await this.fetch('/api/dashboard/extensions');
            },

            async fetchModels(providerName) {
                return await this.fetch(`/api/providers/${providerName}/models`);
            },

            async oauthStatus(provider) {
                return await this.fetch(`/api/oauth/${provider}/status`);
            },

            async oauthStart(provider) {
                return await this.fetch(`/api/oauth/${provider}/start`, { method: 'POST' });
            },

            async oauthCallback(provider, code) {
                return await this.fetch(`/api/oauth/${provider}/callback`, {
                    method: 'POST',
                    body: JSON.stringify({ code }),
                });
            },

            connectChat() {
                if (this.ws) return;
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${proto}//${location.host}/ws/chat`);
                this.ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    if (data.type === 'response') {
                        appendChatMessage('assistant', data.content);
                    } else if (data.type === 'progress') {
                        updateChatProgress(data.content);
                    }
                };
                this.ws.onclose = () => { this.ws = null; };
            },

            sendChatMessage(text) {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.connectChat();
                    setTimeout(() => this.sendChatMessage(text), 500);
                    return;
                }
                this.ws.send(JSON.stringify({ content: text }));
            },

            connectEvents() {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.eventsWs = new WebSocket(`${proto}//${location.host}/ws/events`);
                this.eventsWs.onmessage = async (e) => {
                    const data = JSON.parse(e.data);
                    if (data.event === 'config:updated') {
                        this.loadConfig();
                    }
                    if (data.event && data.event.startsWith('dashboard:extension:')) {
                        const extensions = await this.loadExtensions();
                        if (extensions) renderExtensions(extensions);
                    }
                };
                this.eventsWs.onclose = () => {
                    setTimeout(() => this.connectEvents(), 3000);
                };
            },
        };

        // --- Helper functions for chat WebSocket ---
        function appendChatMessage(role, content) {
            const messages = document.getElementById('chatMessages');
            if (!messages) return;
            const msg = document.createElement('div');
            msg.className = `chat-message ${role === 'assistant' ? 'agent' : 'user'}`;
            msg.textContent = content;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateChatProgress(content) {
            // Could show a typing indicator or progress message
            console.log('Progress:', content);
        }

        // --- Apply Backend Config ---
        function applyBackendConfig(data) {
            // Providers
            if (data.providers) {
                for (const [key, pConfig] of Object.entries(data.providers)) {
                    const id = key.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
                    if (!state.providers[id]) state.providers[id] = { enabled: false, fields: {} };
                    const sp = state.providers[id];
                    sp.enabled = !!(pConfig.apiKey || pConfig.apiBase);
                    sp.fields = {};
                    if (pConfig.apiKey) sp.fields.api_key = pConfig.apiKey;
                    if (pConfig.apiBase) sp.fields.base_url = pConfig.apiBase;
                }
            }

            // Channels
            if (data.channels) {
                for (const [key, cConfig] of Object.entries(data.channels)) {
                    const id = key.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
                    if (!state.channels[id]) state.channels[id] = { enabled: false, fields: {} };
                    state.channels[id].enabled = cConfig.enabled || false;
                    state.channels[id].fields = {};
                    for (const [fk, fv] of Object.entries(cConfig)) {
                        if (fk === 'enabled') continue;
                        const snakeKey = fk.replace(/([A-Z])/g, '_$1').toLowerCase();
                        if (typeof fv === 'string' || typeof fv === 'number') {
                            state.channels[id].fields[snakeKey] = fv;
                        } else if (Array.isArray(fv)) {
                            state.channels[id].fields[snakeKey] = fv.join(',');
                        }
                    }
                }
            }

            // Agent config
            if (data.agents?.defaults) {
                const d = data.agents.defaults;
                state.agentConfig.model = d.model || state.agentConfig.model;
                state.agentConfig.workspace = d.workspace || state.agentConfig.workspace;
                state.agentConfig.temperature = d.temperature ?? state.agentConfig.temperature;
                state.agentConfig.max_tokens = d.maxTokens ?? state.agentConfig.max_tokens;
                // Sync chat page model/provider from backend config
                if (d.model) {
                    const chatModelEl = document.getElementById('chatModel');
                    if (chatModelEl) chatModelEl.value = d.model;
                }
                if (d.provider || state.agentConfig.provider) {
                    const chatProviderEl = document.getElementById('chatProvider');
                    const prov = d.provider || state.agentConfig.provider;
                    if (chatProviderEl && prov) {
                        chatProviderEl.value = prov;
                        _loadChatModels(prov);
                    }
                }
                state.agentConfig.max_iterations = d.maxToolIterations ?? state.agentConfig.max_iterations;
                state.agentConfig.memory_window = d.memoryWindow ?? state.agentConfig.memory_window;
            }

            // Tools
            if (data.tools) {
                if (data.tools.exec) {
                    if (!state.tools.shell) state.tools.shell = { enabled: true, fields: {} };
                    state.tools.shell.fields.timeout = data.tools.exec.timeout;
                }
                if (data.tools.web?.search?.apiKey) {
                    if (!state.tools.websearch) state.tools.websearch = { enabled: true, fields: {} };
                    state.tools.websearch.fields.api_key = data.tools.web.search.apiKey;
                }
            }

            // Re-render everything
            renderProviders();
            renderChannels();
            renderTools();
            populateAgentConfigForm();
            updateStats();
            syncConfig();
            toast('Config loaded from backend');
            updateConnectionStatus(true);
        }

        // --- Update Connection Status ---
        function updateConnectionStatus(connected) {
            const el = document.getElementById('connectionStatus');
            if (!el) return;
            const dot = el.querySelector('.status-dot');
            const text = el.querySelector('.status-text');
            if (connected) {
                el.classList.add('online');
                dot.classList.remove('offline');
                dot.classList.add('online');
                text.textContent = 'Connected';
            } else {
                el.classList.remove('online');
                dot.classList.add('offline');
                dot.classList.remove('online');
                text.textContent = 'Offline';
            }
        }

        // --- Mutable Data Registries ---
        const providers = [
            { id: 'anthropic', name: 'Anthropic', color: 'primary', tags: ['LLM'], fields: ['api_key', 'base_url'], promptCaching: true, note: 'Claude models. Base URL optional (for proxy).' },
            { id: 'openai', name: 'OpenAI', color: 'success', tags: ['LLM'], fields: ['api_key', 'base_url'], note: 'GPT and o-series models. Base URL optional.' },
            { id: 'deepseek', name: 'DeepSeek', color: 'info', tags: ['LLM'], fields: ['api_key', 'base_url'], note: 'DeepSeek Chat, Coder, Reasoner' },
            { id: 'gemini', name: 'Gemini', color: 'warning', tags: ['LLM'], fields: ['api_key'], note: 'Google Gemini models' },
            { id: 'groq', name: 'Groq', color: 'danger', tags: ['LLM'], fields: ['api_key'], note: 'Fast inference. Also supports Whisper transcription.' },
            { id: 'openrouter', name: 'OpenRouter', color: 'primary', tags: ['ROUTER'], fields: ['api_key'], promptCaching: true, note: 'Routes to 200+ models from all providers' },
            { id: 'aihubmix', name: 'AiHubMix', color: 'success', tags: ['ROUTER'], fields: ['api_key', 'base_url'], note: 'Global gateway, OpenAI-compatible' },
            { id: 'siliconflow', name: 'SiliconFlow', color: 'info', tags: ['ROUTER'], fields: ['api_key', 'base_url'], note: 'SiliconFlow gateway' },
            { id: 'volcengine', name: 'VolcEngine', color: 'warning', tags: ['ROUTER'], fields: ['api_key', 'base_url'], note: 'Volcengine / Doubao models' },
            { id: 'dashscope', name: 'DashScope/Qwen', color: 'danger', tags: ['LLM'], fields: ['api_key'], note: 'Alibaba Qwen models' },
            { id: 'zhipu', name: 'Zhipu', color: 'primary', tags: ['LLM'], fields: ['api_key'], note: 'GLM models (Zhipu AI)' },
            { id: 'moonshot', name: 'Moonshot', color: 'success', tags: ['LLM'], fields: ['api_key', 'base_url'], note: 'Kimi models. Default: api.moonshot.ai' },
            { id: 'minimax', name: 'MiniMax', color: 'info', tags: ['LLM'], fields: ['api_key'], note: 'MiniMax models' },
            { id: 'vllm', name: 'vLLM', color: 'warning', tags: ['LOCAL'], fields: ['base_url', 'api_key'], note: 'Local vLLM or any OpenAI-compatible server' },
            { id: 'openai_codex', name: 'OpenAI Codex', color: 'success', tags: ['LLM', 'OAUTH'], fields: [], isOAuth: true, note: 'OAuth login required. Run: nanobot provider login openai-codex' },
            { id: 'github_copilot', name: 'GitHub Copilot', color: 'primary', tags: ['LLM', 'OAUTH'], fields: [], isOAuth: true, note: 'OAuth login required. Run: nanobot provider login github-copilot' },
            { id: 'custom', name: 'Custom', color: 'danger', tags: ['CUSTOM'], fields: ['base_url', 'api_key'], note: 'Any OpenAI-compatible endpoint' }
        ];

        const channels = [
            { id: 'telegram', name: 'Telegram', icon: 'üì±', description: 'Telegram bot integration', fields: ['bot_token', 'webhook_url'], note: 'Configurable reply-to, /help bypasses ACL' },
            { id: 'discord', name: 'Discord', icon: 'üí¨', description: 'Discord bot integration', fields: ['bot_token', 'guild_id'], note: 'Auto-split 2000 chars, Socket Mode, Message Content Intent' },
            { id: 'whatsapp', name: 'WhatsApp', icon: 'üìû', description: 'WhatsApp integration via QR scan', fields: [], hasQrScan: true, note: 'Requires Node.js >= 18, QR scan linking' },
            { id: 'slack', name: 'Slack', icon: 'üíº', description: 'Slack workspace integration', fields: ['bot_token', 'signing_secret', 'app_token'], note: 'Socket Mode, file uploads' },
            { id: 'email', name: 'Email', icon: 'üìß', description: 'IMAP/SMTP email integration', fields: ['smtp_host', 'smtp_port', 'username', 'password', 'imap_host'], note: 'IMAP polling + SMTP reply' },
            { id: 'qq', name: 'QQ', icon: 'üêß', description: 'QQ bot integration', fields: ['app_id', 'token'], note: 'botpy SDK, WebSocket, private messages' },
            { id: 'feishu', name: 'Feishu', icon: 'üöÄ', description: 'Feishu/Lark bot integration', fields: ['app_id', 'app_secret', 'verification_token'], isNew: true, note: 'WebSocket, media support' },
            { id: 'dingtalk', name: 'DingTalk', icon: 'üì≤', description: 'DingTalk bot integration', fields: ['client_id', 'client_secret'], note: 'Stream Mode' },
            { id: 'mochat', name: 'MoChat', icon: 'üí¨', description: 'MoChat enterprise integration', fields: ['base_url', 'token'], note: 'Socket.IO WebSocket + HTTP fallback' },
            { id: 'cli', name: 'CLI', icon: '‚å®Ô∏è', description: 'Command line interface', fields: [], alwaysEnabled: true, note: 'Built-in terminal, always active' }
        ];

        const tools = [
            { id: 'shell', name: 'Shell', description: 'Execute shell commands', fields: [{ name: 'timeout', type: 'number', label: 'Timeout (seconds)', default: 60 }] },
            { id: 'filesystem', name: 'Filesystem', description: 'File operations and management', fields: [] },
            { id: 'websearch', name: 'Web Search', description: 'Search the web (Brave Search API)', fields: [{ name: 'api_key', type: 'password', label: 'Brave Search API Key', default: '' }], note: 'Get a free key at <a href="https://brave.com/search/api/" target="_blank" style="color:var(--primary-600)">brave.com/search/api</a> ‚Äî 2,000 queries/month free' },
            { id: 'cron', name: 'Cron Scheduler', description: 'Schedule recurring tasks', fields: [], note: 'Natural language parsing supported' },
            { id: 'spawn', name: 'Spawn/Subagents', description: 'Create subagent instances', fields: [{ name: 'max_concurrent', type: 'number', label: 'Max Concurrent', default: 3 }] },
            { id: 'mcp', name: 'MCP Servers', description: 'Model Context Protocol servers', fields: [], hasButton: true }
        ];

        // --- Page title registry (mutable) ---
        const pageTitles = {
            overview: 'Overview', agent: 'Agent Config', providers: 'Providers',
            channels: 'Channels', tools: 'Tools', skills: 'Skills',
            memory: 'Memory', cron: 'Cron Jobs', subagents: 'Subagents Monitor',
            changelog: 'Changelog', chat: 'Chat'
        };

        // --- Event System ---
        function emitEvent(name, detail) {
            window.dispatchEvent(new CustomEvent('nanobot:' + name, { detail }));
            window.dispatchEvent(new CustomEvent('nanobot:change', { detail: { type: name, ...detail } }));
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadState();
            renderProviders();
            renderChannels();
            renderTools();
            renderSkillsTable();
            renderCronTable();
            renderSubagents();
            renderActivityFeed();
            populateAgentConfigForm();
            updateStats();
            syncConfig();

            // Try connecting to backend
            const loaded = await NanobotAPI.loadConfig();
            if (loaded) {
                NanobotAPI.connectEvents();
                // Load skills from backend
                const skills = await NanobotAPI.loadSkills();
                if (skills) {
                    state.skills = skills.map(s => ({ name: s.name, summary: s.description || '', enabled: true, content: '' }));
                    renderSkillsTable();
                }
                // Load memory from backend
                const mem = await NanobotAPI.loadMemory();
                if (mem) {
                    state.memory = mem.memory || '';
                    const memEditor = document.getElementById('memoryContent');
                    if (memEditor) memEditor.value = state.memory;
                }
                // Load cron from backend
                const jobs = await NanobotAPI.loadCronJobs();
                if (jobs) {
                    state.cronJobs = jobs.map(j => ({
                        id: j.id,
                        schedule: j.schedule.expr || (j.schedule.everyMs ? `every ${j.schedule.everyMs/1000}s` : 'one-time'),
                        task: j.payload.message,
                        active: j.enabled,
                    }));
                    renderCronTable();
                }
                // Update status
                const status = await NanobotAPI.getStatus();
                if (status) {
                    document.getElementById('pageTitle').textContent = `Overview ‚Äî ${status.version}`;
                }
            }

            // Check if setup wizard should be shown
            if (NanobotAPI.connected) {
                const hasAnyKey = Object.values(state.providers).some(p => p.enabled || p.fields?.api_key);
                if (!hasAnyKey) {
                    showSetupWizard();
                }
            }

            // Load dashboard extensions (custom pages & widgets from agent)
            if (NanobotAPI.connected) {
                const extensions = await NanobotAPI.loadExtensions();
                if (extensions) {
                    renderExtensions(extensions);
                }
            }

            emitEvent('ready', { state, backendConnected: NanobotAPI.connected });
        });

        // --- Dashboard Extensions ---
        function renderExtensions(ext) {
            // Render custom pages as sidebar nav items + page containers
            const pages = ext.pages || {};
            const sidebar = document.querySelector('.sidebar-nav');
            const pageContainer = document.querySelector('.main-content');
            const existingExtNav = document.querySelectorAll('.nav-item[data-ext]');
            existingExtNav.forEach(el => el.remove());
            const existingExtPages = document.querySelectorAll('.page[data-ext]');
            existingExtPages.forEach(el => el.remove());

            const pageIds = Object.keys(pages);
            if (pageIds.length > 0) {
                // Add a section label if there are custom pages
                let extSection = document.getElementById('extNavSection');
                if (!extSection) {
                    extSection = document.createElement('div');
                    extSection.id = 'extNavSection';
                    extSection.className = 'nav-section';
                    extSection.innerHTML = '<div class="nav-section-label">Extensions</div>';
                    sidebar.appendChild(extSection);
                }

                pageIds.forEach(id => {
                    const pg = pages[id];
                    // Nav item
                    const nav = document.createElement('div');
                    nav.className = 'nav-item';
                    nav.dataset.page = 'ext-' + id;
                    nav.dataset.ext = id;
                    nav.onclick = function() { navigate('ext-' + id, this); };
                    nav.innerHTML = `<div class="nav-item-label"><span class="nav-item-icon">${pg.icon || 'üì¶'}</span>${pg.title || id}</div>`;
                    extSection.appendChild(nav);

                    // Page container
                    const page = document.createElement('div');
                    page.id = 'ext-' + id;
                    page.className = 'page';
                    page.dataset.ext = id;
                    page.style.display = 'none';
                    page.innerHTML = pg.html || '';
                    pageContainer.appendChild(page);

                    // Inject CSS
                    if (pg.css) {
                        const style = document.createElement('style');
                        style.textContent = pg.css;
                        style.dataset.ext = id;
                        document.head.appendChild(style);
                    }

                    // Execute JS
                    if (pg.js) {
                        try { new Function(pg.js)(); } catch(e) { console.warn('Extension JS error (' + id + '):', e); }
                    }
                });
            }

            // Render widgets into overview page
            const widgets = ext.widgets || [];
            let widgetContainer = document.getElementById('extWidgets');
            if (!widgetContainer) {
                const overview = document.getElementById('overview');
                if (overview) {
                    widgetContainer = document.createElement('div');
                    widgetContainer.id = 'extWidgets';
                    widgetContainer.style.marginTop = '24px';
                    overview.appendChild(widgetContainer);
                }
            }
            if (widgetContainer) {
                widgetContainer.innerHTML = '';
                widgets.forEach(w => {
                    const div = document.createElement('div');
                    div.className = 'mb-24';
                    div.dataset.ext = w.id;
                    div.innerHTML = w.html || '';
                    widgetContainer.appendChild(div);

                    if (w.css) {
                        const style = document.createElement('style');
                        style.textContent = w.css;
                        style.dataset.ext = w.id;
                        document.head.appendChild(style);
                    }
                    if (w.js) {
                        try { new Function(w.js)(); } catch(e) { console.warn('Widget JS error (' + w.id + '):', e); }
                    }
                });
            }
        }

        // --- Setup Wizard Functions ---
        const wizardProviderHints = {
            openrouter: { label: 'OPENROUTER API KEY', placeholder: 'sk-or-...', hint: 'Get one at <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--primary-600)">openrouter.ai/keys</a> ‚Äî routes to any model', fields: ['api_key'] },
            anthropic: { label: 'ANTHROPIC API KEY', placeholder: 'sk-ant-...', hint: 'Get one at <a href="https://console.anthropic.com/keys" target="_blank" style="color:var(--primary-600)">console.anthropic.com</a>', fields: ['api_key'] },
            openai: { label: 'OPENAI API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--primary-600)">platform.openai.com</a>', fields: ['api_key'] },
            deepseek: { label: 'DEEPSEEK API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://platform.deepseek.com" target="_blank" style="color:var(--primary-600)">platform.deepseek.com</a>', fields: ['api_key'] },
            gemini: { label: 'GEMINI API KEY', placeholder: 'AI...', hint: 'Get one at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary-600)">aistudio.google.com</a>', fields: ['api_key'] },
            groq: { label: 'GROQ API KEY', placeholder: 'gsk_...', hint: 'Get one at <a href="https://console.groq.com/keys" target="_blank" style="color:var(--primary-600)">console.groq.com</a> ‚Äî also supports Whisper transcription', fields: ['api_key'] },
            aihubmix: { label: 'AIHUBMIX API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://aihubmix.com" target="_blank" style="color:var(--primary-600)">aihubmix.com</a> ‚Äî OpenAI-compatible gateway', fields: ['api_key'] },
            siliconflow: { label: 'SILICONFLOW API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://cloud.siliconflow.cn" target="_blank" style="color:var(--primary-600)">cloud.siliconflow.cn</a>', fields: ['api_key'] },
            volcengine: { label: 'VOLCENGINE API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://console.volcengine.com" target="_blank" style="color:var(--primary-600)">console.volcengine.com</a> ‚Äî Ark models', fields: ['api_key', 'base_url'] },
            dashscope: { label: 'DASHSCOPE API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://dashscope.console.aliyun.com" target="_blank" style="color:var(--primary-600)">dashscope.console.aliyun.com</a> ‚Äî Alibaba Qwen models', fields: ['api_key'] },
            zhipu: { label: 'ZHIPU API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://open.bigmodel.cn" target="_blank" style="color:var(--primary-600)">open.bigmodel.cn</a> ‚Äî GLM models', fields: ['api_key'] },
            moonshot: { label: 'MOONSHOT API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://platform.moonshot.cn" target="_blank" style="color:var(--primary-600)">platform.moonshot.cn</a> ‚Äî Kimi models', fields: ['api_key'] },
            minimax: { label: 'MINIMAX API KEY', placeholder: 'sk-...', hint: 'Get one at <a href="https://platform.minimax.chat" target="_blank" style="color:var(--primary-600)">platform.minimax.chat</a>', fields: ['api_key'] },
            vllm: { label: 'VLLM BASE URL', placeholder: 'http://localhost:8000/v1', hint: 'URL of your local vLLM or OpenAI-compatible server', fields: ['base_url', 'model'], isLocal: true },
            openai_codex: { label: 'OPENAI CODEX', placeholder: '', hint: 'OAuth-based ‚Äî run <code style="background:var(--bg-subtle);padding:2px 6px;border-radius:4px;font-size:12px;">nanobot provider login openai-codex</code> in your terminal to authenticate', fields: [], isOAuth: true },
            github_copilot: { label: 'GITHUB COPILOT', placeholder: '', hint: 'OAuth-based ‚Äî run <code style="background:var(--bg-subtle);padding:2px 6px;border-radius:4px;font-size:12px;">nanobot provider login github-copilot</code> in your terminal to authenticate', fields: [], isOAuth: true },
            custom: { label: 'CUSTOM API BASE URL', placeholder: 'http://localhost:8000/v1', hint: 'Any OpenAI-compatible endpoint', fields: ['base_url', 'api_key', 'model'], isLocal: true },
        };

        function showSetupWizard() {
            const el = document.getElementById('setupWizard');
            if (el) el.classList.remove('hidden');
        }

        function dismissWizard() {
            const el = document.getElementById('setupWizard');
            if (el) el.classList.add('hidden');
        }

        function wizardSelectProvider(pill) {
            document.querySelectorAll('.provider-pill').forEach(p => p.classList.remove('selected'));
            pill.classList.add('selected');
            const provider = pill.dataset.provider;
            // Pre-load models so the wizard model dropdown is ready
            _wizardModels = [];
            if (provider && provider !== 'openai_codex' && provider !== 'github_copilot') {
                _loadWizardModels(provider);
            }
            const info = wizardProviderHints[provider] || {};

            const keyField = document.getElementById('wizardKeyField');
            const baseUrlField = document.getElementById('wizardBaseUrlField');
            const modelField = document.getElementById('wizardModelField');
            const oauthFlow = document.getElementById('wizardOAuthFlow');
            const saveBtn = document.getElementById('wizardSaveBtn');
            const oauthStartBtn = document.getElementById('wizardOAuthStartBtn');
            const oauthSubmitBtn = document.getElementById('wizardOAuthSubmitBtn');

            // Reset OAuth flow state
            oauthFlow.style.display = 'none';
            oauthStartBtn.style.display = 'none';
            oauthSubmitBtn.style.display = 'none';
            saveBtn.style.display = '';
            document.getElementById('wizardOAuthCodeField').style.display = 'none';
            document.getElementById('wizardOAuthStatus').innerHTML = 'Click "Start Login" to begin the OAuth authentication flow.';

            if (info.isOAuth) {
                // OAuth providers: hide all input fields, show OAuth flow
                keyField.style.display = 'none';
                baseUrlField.style.display = 'none';
                modelField.style.display = 'none';
                oauthFlow.style.display = '';
                saveBtn.style.display = 'none';
                oauthStartBtn.style.display = '';
                document.getElementById('wizardOAuthLabel').textContent = info.label || 'OAUTH LOGIN';

                // Check if already authenticated
                if (NanobotAPI.connected) {
                    NanobotAPI.oauthStatus(provider).then(status => {
                        if (status && status.authenticated) {
                            document.getElementById('wizardOAuthStatus').innerHTML =
                                '<span style="color:var(--success-600);font-weight:600;">Authenticated</span>' +
                                (status.accountId ? ` &mdash; ${status.accountId}` : '') +
                                '<br>You can skip setup or dismiss this wizard.';
                            oauthStartBtn.style.display = 'none';
                            saveBtn.style.display = '';
                            saveBtn.textContent = 'Done';
                        }
                    });
                }
            } else if (info.isLocal) {
                // Local providers: show base_url, optionally hide API key
                baseUrlField.style.display = '';
                modelField.style.display = '';
                document.getElementById('wizardBaseUrl').style.display = '';
                document.getElementById('wizardBaseUrlLabel').textContent = info.label || 'BASE URL';
                document.getElementById('wizardBaseUrl').placeholder = info.placeholder || 'http://localhost:8000/v1';
                document.getElementById('wizardBaseUrlHint').innerHTML = info.hint || '';

                if (info.fields && info.fields.includes('api_key')) {
                    keyField.style.display = '';
                    document.getElementById('wizardKeyLabel').textContent = 'API KEY (optional)';
                    document.getElementById('wizardApiKey').placeholder = 'sk-...';
                    document.getElementById('wizardKeyHint').innerHTML = 'Leave blank if your server has no auth';
                } else {
                    keyField.style.display = 'none';
                }
            } else {
                // Cloud providers: show API key, hide base_url
                baseUrlField.style.display = 'none';
                modelField.style.display = '';
                document.getElementById('wizardBaseUrl').style.display = '';
                keyField.style.display = '';
                document.getElementById('wizardKeyLabel').textContent = info.label || 'API KEY';
                document.getElementById('wizardApiKey').placeholder = info.placeholder || 'sk-...';
                document.getElementById('wizardKeyHint').innerHTML = info.hint || '';
            }
        }

        let _oauthCurrentProvider = null;

        async function startOAuthFromWizard() {
            const selectedPill = document.querySelector('.provider-pill.selected');
            const provider = selectedPill ? selectedPill.dataset.provider : null;
            if (!provider) return;
            _oauthCurrentProvider = provider;

            const statusEl = document.getElementById('wizardOAuthStatus');
            const startBtn = document.getElementById('wizardOAuthStartBtn');
            const submitBtn = document.getElementById('wizardOAuthSubmitBtn');
            const codeField = document.getElementById('wizardOAuthCodeField');

            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';
            statusEl.innerHTML = 'Initiating OAuth flow...';

            const result = await NanobotAPI.oauthStart(provider);

            if (!result) {
                statusEl.innerHTML = '<span style="color:var(--danger-600);">Failed to start OAuth flow. Check server logs.</span>';
                startBtn.disabled = false;
                startBtn.textContent = 'Retry';
                return;
            }

            if (provider === 'openai_codex') {
                const url = result.authUrl;
                statusEl.innerHTML =
                    '<strong>Step 1:</strong> Open this link in your browser and log in with OpenAI:<br>' +
                    `<a href="${url}" target="_blank" style="color:var(--primary-600);word-break:break-all;">${url.substring(0, 80)}...</a><br><br>` +
                    '<strong>Step 2:</strong> After logging in, you will be redirected. Paste the full callback URL or authorization code below.';
                codeField.style.display = '';
                startBtn.style.display = 'none';
                submitBtn.style.display = '';
            } else if (provider === 'github_copilot') {
                let html = '<strong>GitHub Copilot Device Flow</strong><br>';
                if (result.deviceUrl) {
                    html += `Open: <a href="${result.deviceUrl}" target="_blank" style="color:var(--primary-600);">${result.deviceUrl}</a><br>`;
                }
                if (result.deviceCode) {
                    html += `Enter code: <code style="background:var(--bg-base);padding:4px 10px;border-radius:4px;font-size:16px;font-weight:700;letter-spacing:2px;">${result.deviceCode}</code><br>`;
                }
                if (result.output && result.output.length) {
                    html += '<br><details><summary style="cursor:pointer;font-size:12px;color:var(--text-muted);">Server output</summary><pre style="font-size:11px;max-height:150px;overflow:auto;margin-top:4px;padding:8px;background:var(--bg-base);border-radius:4px;">' +
                        result.output.join('\n') + '</pre></details>';
                }
                if (result.done && result.success !== false) {
                    html += '<br><span style="color:var(--success-600);font-weight:600;">Authentication complete!</span>';
                    submitBtn.style.display = 'none';
                    document.getElementById('wizardSaveBtn').style.display = '';
                    document.getElementById('wizardSaveBtn').textContent = 'Done';
                } else {
                    html += '<br>Complete the login in your browser, then click "Check Status".';
                    startBtn.textContent = 'Check Status';
                    startBtn.disabled = false;
                    startBtn.style.display = '';
                }
                statusEl.innerHTML = html;
            }
        }

        async function submitOAuthFromWizard() {
            const code = document.getElementById('wizardOAuthCode').value.trim();
            if (!code) {
                toast('Please paste the callback URL or authorization code');
                return;
            }

            const statusEl = document.getElementById('wizardOAuthStatus');
            const submitBtn = document.getElementById('wizardOAuthSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Verifying...';

            const result = await NanobotAPI.oauthCallback(_oauthCurrentProvider, code);

            if (result && result.authenticated) {
                statusEl.innerHTML =
                    '<span style="color:var(--success-600);font-weight:600;">Authenticated successfully!</span>' +
                    (result.accountId ? ` &mdash; ${result.accountId}` : '');
                submitBtn.style.display = 'none';
                document.getElementById('wizardOAuthCodeField').style.display = 'none';

                // Enable the provider in local state
                if (!state.providers[_oauthCurrentProvider]) state.providers[_oauthCurrentProvider] = { enabled: false, fields: {} };
                state.providers[_oauthCurrentProvider].enabled = true;
                renderProviders();
                updateStats();
                saveState();
                syncConfig();

                // Show done button
                const saveBtn = document.getElementById('wizardSaveBtn');
                saveBtn.style.display = '';
                saveBtn.textContent = 'Done';
                saveBtn.onclick = dismissWizard;
            } else {
                const errMsg = result?.error || 'Authentication failed. Check the code and try again.';
                statusEl.innerHTML += `<br><span style="color:var(--danger-600);">${errMsg}</span>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Code';
            }
        }

        async function completeWizard() {
            const selectedPill = document.querySelector('.provider-pill.selected');
            const provider = selectedPill ? selectedPill.dataset.provider : 'openrouter';
            const info = wizardProviderHints[provider] || {};
            const apiKey = document.getElementById('wizardApiKey').value.trim();
            const baseUrl = document.getElementById('wizardBaseUrl').value.trim();
            const model = document.getElementById('wizardModel').value.trim();

            // Validate required fields based on provider type
            if (info.isOAuth) {
                // OAuth providers don't need any credentials from the wizard
            } else if (info.isLocal) {
                if (!baseUrl) {
                    toast('Please enter a base URL');
                    return;
                }
            } else {
                if (!apiKey) {
                    toast('Please enter an API key');
                    return;
                }
            }

            // Build the config payload for this provider
            const providerConfig = {};
            if (apiKey) providerConfig.apiKey = apiKey;
            if (baseUrl) providerConfig.apiBase = baseUrl;

            // Save provider to backend
            if (NanobotAPI.connected) {
                await NanobotAPI.saveProviderConfig(provider, providerConfig);

                // Save model if specified
                if (model) {
                    await NanobotAPI.saveAgentConfig({
                        defaults: {
                            model: model,
                            workspace: '~/.nanobot/workspace',
                            maxTokens: 8192,
                            temperature: 0.7,
                            maxToolIterations: 20,
                            memoryWindow: 50,
                        }
                    });
                    state.agentConfig.model = model;
                }

                // Update local state
                if (!state.providers[provider]) state.providers[provider] = { enabled: false, fields: {} };
                state.providers[provider].enabled = true;
                if (apiKey) state.providers[provider].fields.api_key = apiKey;
                if (baseUrl) state.providers[provider].fields.base_url = baseUrl;

                renderProviders();
                populateAgentConfigForm();
                updateStats();
                saveState();
                syncConfig();

                toast('Setup complete ‚Äî ' + provider + ' configured');
            } else {
                // Offline mode ‚Äî just save to localStorage
                if (!state.providers[provider]) state.providers[provider] = { enabled: false, fields: {} };
                state.providers[provider].enabled = true;
                if (apiKey) state.providers[provider].fields.api_key = apiKey;
                if (baseUrl) state.providers[provider].fields.base_url = baseUrl;
                if (model) state.agentConfig.model = model;
                renderProviders();
                populateAgentConfigForm();
                updateStats();
                saveState();
                syncConfig();
                toast('Provider configured (offline mode)');
            }

            dismissWizard();
        }

        // --- Navigation ---
        function navigate(pageId, element) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');
            if (element) element.classList.add('active');
            else {
                document.querySelectorAll('.nav-item').forEach(n => {
                    if (n.getAttribute('data-page') === pageId) n.classList.add('active');
                });
            }
            document.getElementById('pageTitle').textContent = pageTitles[pageId] || pageId;
            emitEvent('navigate', { pageId });
            // Auto-load chat models when navigating to chat page
            if (pageId === 'chat') {
                const provider = document.getElementById('chatProvider')?.value || 'anthropic';
                _loadChatModels(provider);
            }
        }

        // --- Collect field values from a card's inputs ---
        function collectCardFields(cardEl) {
            const vals = {};
            cardEl.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(inp => {
                // Prefer explicit data-field-name attribute over label-derived key
                let key = inp.dataset.fieldName;
                if (!key) {
                    const label = inp.closest('.form-group')?.querySelector('.form-label');
                    if (label) {
                        key = label.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                    }
                }
                if (key) {
                    vals[key] = inp.value;
                }
            });
            cardEl.querySelectorAll('.form-checkbox input[type="checkbox"]').forEach(cb => {
                const label = cb.closest('.form-checkbox')?.querySelector('label');
                if (label) {
                    const key = label.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                    vals[key] = cb.checked;
                }
            });
            return vals;
        }

        // --- Restore field values into a card's inputs ---
        function restoreCardFields(cardEl, vals) {
            if (!vals) return;
            cardEl.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(inp => {
                let key = inp.dataset.fieldName;
                if (!key) {
                    const label = inp.closest('.form-group')?.querySelector('.form-label');
                    if (label) {
                        key = label.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                    }
                }
                if (key && vals[key] !== undefined) inp.value = vals[key];
            });
            cardEl.querySelectorAll('.form-checkbox input[type="checkbox"]').forEach(cb => {
                const label = cb.closest('.form-checkbox')?.querySelector('label');
                if (label) {
                    const key = label.textContent.trim().toLowerCase().replace(/\s+/g, '_');
                    if (vals[key] !== undefined) cb.checked = vals[key];
                }
            });
        }

        // --- Save field values before re-render ---
        function saveFieldsBeforeRender(containerSel, dataKey) {
            document.querySelectorAll(containerSel).forEach(card => {
                const id = card.getAttribute('data-id');
                if (id && state[dataKey][id]) {
                    state[dataKey][id].fields = collectCardFields(card);
                }
            });
        }

        // --- Restore field values after re-render ---
        function restoreFieldsAfterRender(containerSel, dataKey) {
            document.querySelectorAll(containerSel).forEach(card => {
                const id = card.getAttribute('data-id');
                if (id && state[dataKey][id]?.fields) {
                    restoreCardFields(card, state[dataKey][id].fields);
                }
            });
        }

        // --- Render Providers ---
        function renderProviders() {
            saveFieldsBeforeRender('.provider-card', 'providers');
            const grid = document.getElementById('providerGrid');
            grid.innerHTML = providers.map(p => {
                const pState = state.providers[p.id] || {};
                const enabled = pState.enabled || false;
                const badges = p.tags.map(t => {
                    if (t === 'LLM') return '<span class="badge badge-gray">LLM</span>';
                    if (t === 'ROUTER') return '<span class="badge badge-warning">ROUTER</span>';
                    if (t === 'LOCAL') return '<span class="badge badge-info">LOCAL</span>';
                    if (t === 'CUSTOM') return '<span class="badge badge-primary">CUSTOM</span>';
                    if (t === 'OAUTH') return '<span class="badge badge-warning">OAUTH</span>';
                    return `<span class="badge badge-gray">${t}</span>`;
                }).join('');
                const newBadge = p.isNew ? '<span class="badge badge-new">NEW</span>' : '';
                const fields = p.fields.map(f => `
                    <div class="form-group">
                        <label class="form-label">${f.replace(/_/g, ' ').toUpperCase()}</label>
                        <input type="${f.includes('key') || f.includes('token') || f.includes('secret') ? 'password' : 'text'}" class="form-input mono" data-field-name="${f}" placeholder="${f}" onchange="onFieldChange('providers','${p.id}')">
                    </div>
                `).join('');
                const caching = p.promptCaching ? `
                    <div class="form-checkbox">
                        <input type="checkbox" id="${p.id}_caching" ${pState.fields?.enable_prompt_caching ? 'checked' : ''} onchange="onFieldChange('providers','${p.id}')">
                        <label for="${p.id}_caching">Enable prompt caching</label>
                    </div>
                ` : '';
                const note = p.note ? `<div class="provider-note">${p.note}</div>` : '';
                const oauthBtn = p.isOAuth ? `
                    <button class="btn btn-primary" style="margin-top:8px;font-size:12px;padding:6px 16px;" onclick="startProviderOAuth('${p.id}')">
                        Login with OAuth
                    </button>
                    <div id="oauthStatus_${p.id}" style="margin-top:6px;font-size:12px;"></div>
                ` : '';
                return `
                    <div class="provider-card ${enabled ? 'enabled' : ''} color-${p.color}" data-id="${p.id}">
                        <div class="provider-header">
                            <div class="provider-info">
                                <div class="provider-icon color-${p.color}">${p.name[0]}</div>
                                <div class="provider-name-wrapper">
                                    <div class="provider-name">${p.name}</div>
                                    <div class="provider-tags">${badges}${newBadge}</div>
                                </div>
                            </div>
                            <div class="toggle ${enabled ? 'active' : ''}" onclick="toggleProvider('${p.id}')">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                        <div class="provider-config">
                            ${fields}
                            ${caching}
                            ${oauthBtn}
                            ${note}
                        </div>
                    </div>
                `;
            }).join('');
            restoreFieldsAfterRender('.provider-card', 'providers');
            document.querySelectorAll('.nav-item-count').forEach(el => {
                if (el.id === 'providerCount') el.textContent = providers.length;
            });
        }

        // --- Render Channels ---
        function renderChannels() {
            saveFieldsBeforeRender('.channel-card', 'channels');
            const list = document.getElementById('channelList');
            list.innerHTML = channels.map(c => {
                const cState = state.channels[c.id] || {};
                const enabled = c.alwaysEnabled || cState.enabled || false;
                const newBadge = c.isNew ? '<span class="badge badge-new">NEW</span>' : '';
                const fields = c.fields.map(f => `
                    <div class="form-group">
                        <label class="form-label">${f.replace(/_/g, ' ').toUpperCase()}</label>
                        <input type="${f.includes('token') || f.includes('secret') || f.includes('password') ? 'password' : 'text'}" class="form-input mono" data-field-name="${f}" placeholder="${f}" onchange="onFieldChange('channels','${c.id}')">
                    </div>
                `).join('');
                const qrButton = c.hasQrScan ? '<button class="btn btn-primary whatsapp-qr-button">Start QR Scan</button>' : '';
                const extraFields = c.fields.length > 0 ? `
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Allow From</label>
                            <input type="text" class="form-input mono" data-field-name="allow_from" placeholder="user_id1,user_id2" value="${cState.fields?.allow_from || ''}" onchange="onFieldChange('channels','${c.id}')">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Group Policy</label>
                            <select class="form-select" data-field-name="group_policy" onchange="onFieldChange('channels','${c.id}')">
                                <option ${(cState.fields?.group_policy||'mention')==='mention'?'selected':''}>mention</option>
                                <option ${cState.fields?.group_policy==='open'?'selected':''}>open</option>
                                <option ${cState.fields?.group_policy==='allowlist'?'selected':''}>allowlist</option>
                            </select>
                        </div>
                    </div>
                ` : '';
                const note = c.note ? `<div class="provider-note">${c.note}</div>` : '';
                return `
                    <div class="channel-card ${enabled ? 'enabled' : ''}" data-id="${c.id}">
                        <div class="channel-header">
                            <div class="channel-info">
                                <div class="channel-icon">${c.icon}</div>
                                <div class="channel-details">
                                    <h3>${c.name} ${newBadge}</h3>
                                    <p>${c.description}</p>
                                </div>
                            </div>
                            <div class="toggle ${enabled ? 'active' : ''} ${c.alwaysEnabled ? 'disabled' : ''}" onclick="${c.alwaysEnabled ? '' : `toggleChannel('${c.id}')`}">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                        <div class="channel-config">
                            <div class="form-grid-2">${fields}</div>
                            ${qrButton}
                            ${extraFields}
                            ${note}
                        </div>
                    </div>
                `;
            }).join('');
            restoreFieldsAfterRender('.channel-card', 'channels');
            document.querySelectorAll('.nav-item-count').forEach(el => {
                if (el.id === 'channelCount') el.textContent = channels.length;
            });
        }

        // --- Render Tools ---
        function renderTools() {
            saveFieldsBeforeRender('.tool-card', 'tools');
            const grid = document.getElementById('toolGrid');
            grid.innerHTML = tools.map(t => {
                const tState = state.tools[t.id] || {};
                const enabled = tState.enabled || false;
                const fields = t.fields ? t.fields.map(f => `
                    <div class="form-group">
                        <label class="form-label">${f.label}</label>
                        <input type="${f.type}" class="form-input ${f.type === 'password' ? 'mono' : ''}" data-field-name="${f.name}" value="${tState.fields?.[f.name] ?? f.default}" placeholder="${f.label}" onchange="onFieldChange('tools','${t.id}')">
                    </div>
                `).join('') : '';
                const button = t.hasButton ? '<button class="btn btn-primary mt-16" onclick="openModal(\'addMcpModal\')">Add MCP Server</button>' : '';
                const mcpList = (t.id === 'mcp' && state.mcpServers.length > 0) ? `
                    <div style="margin-top:12px">
                        ${state.mcpServers.map((s,i) => `
                            <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-subtle);border-radius:8px;margin-bottom:8px;border:1px solid var(--border-light)">
                                <div>
                                    <strong>${s.name}</strong>
                                    <span class="text-muted" style="margin-left:8px;font-size:12px">${s.command || s.url || ''}</span>
                                </div>
                                <button class="btn btn-small btn-secondary" onclick="removeMcpServer(${i})">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                ` : '';
                const note = t.note ? `<div class="provider-note">${t.note}</div>` : '';
                return `
                    <div class="tool-card ${enabled ? 'enabled' : ''}" data-id="${t.id}">
                        <div class="tool-header">
                            <div class="tool-info">
                                <h3>${t.name}</h3>
                                <p>${t.description}</p>
                            </div>
                            <div class="toggle ${enabled ? 'active' : ''}" onclick="toggleTool('${t.id}')">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                        <div class="tool-config">
                            ${fields}
                            ${button}
                            ${mcpList}
                            ${note}
                        </div>
                    </div>
                `;
            }).join('');
            restoreFieldsAfterRender('.tool-card', 'tools');
        }

        // --- Render Skills Table ---
        function renderSkillsTable() {
            const tbody = document.getElementById('skillsTable');
            if (!tbody) return;
            tbody.innerHTML = state.skills.map((s, i) => `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.summary}</td>
                    <td>
                        <div class="toggle ${s.enabled ? 'active' : ''}" onclick="toggleSkill(${i})">
                            <div class="toggle-knob"></div>
                        </div>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewSkill(${i})">View</button>
                            <button class="btn btn-small btn-secondary" onclick="removeSkill(${i})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- Render Cron Table ---
        function renderCronTable() {
            const tbody = document.getElementById('cronTable');
            if (!tbody) return;
            tbody.innerHTML = state.cronJobs.map((j, i) => `
                <tr>
                    <td><span class="code-inline">${j.id}</span></td>
                    <td><span class="code-inline">${j.schedule}</span></td>
                    <td>${j.task}</td>
                    <td><span class="badge ${j.active ? 'badge-success' : 'badge-gray'}">${j.active ? 'Active' : 'Paused'}</span></td>
                    <td>${j.lastRun || '-'}</td>
                    <td>${j.nextRun || 'Calculating...'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-small btn-secondary" onclick="toggleCronJob(${i})">${j.active ? 'Pause' : 'Resume'}</button>
                            <button class="btn btn-small btn-secondary" onclick="removeCronJob(${i})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- Render Subagents ---
        function renderSubagents() {
            const grid = document.querySelector('.subagent-grid');
            if (!grid || state.subagents.length === 0) return;
            grid.innerHTML = state.subagents.map((s, i) => {
                const pct = Math.round((s.iteration / s.maxIterations) * 100);
                const isRunning = s.status === 'running';
                return `
                    <div class="subagent-card" ${!isRunning ? 'style="opacity:0.6"' : ''}>
                        <div class="subagent-header">
                            <div class="subagent-name">${s.name}</div>
                            <div class="subagent-status">
                                <div class="status-indicator ${isRunning ? 'running' : ''}"></div>
                                <span class="badge ${isRunning ? 'badge-success' : 'badge-gray'}">${s.status}</span>
                            </div>
                        </div>
                        <div class="subagent-task">${s.task}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                        <div class="subagent-meta">Iteration ${s.iteration}/${s.maxIterations}</div>
                    </div>
                `;
            }).join('');
        }

        // --- Render Activity Feed ---
        function renderActivityFeed() {
            const feed = document.querySelector('.activity-feed');
            if (!feed) return;
            if (state.activityLog.length === 0) {
                // Default activity items
                state.activityLog = [
                    { time: 'now', badge: 'SYS', badgeClass: 'badge-success', message: 'Dashboard initialized' },
                    { time: '2m', badge: 'CFG', badgeClass: 'badge-info', message: 'Loaded default agent configuration' },
                    { time: '5m', badge: 'MEM', badgeClass: 'badge-warning', message: 'Memory consolidation completed' },
                    { time: '12m', badge: 'TOOL', badgeClass: 'badge-primary', message: 'Shell tool executed: npm install' },
                    { time: '18m', badge: 'CH', badgeClass: 'badge-success', message: 'CLI channel ready' },
                    { time: '25m', badge: 'SKILL', badgeClass: 'badge-info', message: 'Loaded skills from workspace' },
                    { time: '32m', badge: 'LLM', badgeClass: 'badge-primary', message: 'Connected to Anthropic API' },
                    { time: '1h', badge: 'SYS', badgeClass: 'badge-success', message: 'Nanobot v0.1.4.post1 started' }
                ];
            }
            feed.innerHTML = state.activityLog.map(a => `
                <div class="activity-item">
                    <div class="activity-time">${a.time}</div>
                    <div class="activity-content">
                        <span class="badge ${a.badgeClass}">${a.badge}</span>
                        <span class="activity-message">${a.message}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- Model combo-box state & functions ---
        let _modelCache = {};       // provider -> [models]
        let _currentModels = [];    // currently shown in dropdown
        let _modelDropdownVisible = false;

        async function onProviderChange() {
            syncConfig();
            const provider = document.getElementById('agentProvider')?.value;
            if (provider) {
                await loadModelsForProvider(provider);
            }
        }

        async function loadModelsForProvider(provider) {
            const loading = document.getElementById('modelLoading');
            const hint = document.getElementById('modelHint');

            // Show from cache instantly if available
            if (_modelCache[provider]) {
                _currentModels = _modelCache[provider];
                renderModelDropdown(_currentModels);
                if (hint) hint.textContent = `${_currentModels.length} models available for ${provider}`;
                return;
            }

            // Try fetching from backend
            if (NanobotAPI.connected) {
                if (loading) loading.style.display = '';
                if (hint) hint.textContent = 'Fetching models...';
                try {
                    const result = await NanobotAPI.fetchModels(provider);
                    if (result && result.models) {
                        _modelCache[provider] = result.models;
                        _currentModels = result.models;
                        renderModelDropdown(_currentModels);
                        const liveTag = result.live ? ' (live)' : '';
                        if (hint) hint.textContent = `${_currentModels.length} models available${liveTag}`;
                    } else {
                        _currentModels = [];
                        renderModelDropdown([]);
                        if (hint) hint.textContent = 'No models found. Type a model name manually.';
                    }
                } catch (e) {
                    _currentModels = [];
                    if (hint) hint.textContent = 'Could not fetch models. Type a model name manually.';
                }
                if (loading) loading.style.display = 'none';
            } else {
                // Offline ‚Äî use built-in fallback lists
                const fallback = _offlineModelLists[provider] || [];
                _modelCache[provider] = fallback;
                _currentModels = fallback;
                renderModelDropdown(fallback);
                if (hint) hint.textContent = fallback.length > 0 ? `${fallback.length} models (offline)` : 'Type a model name manually.';
            }
        }

        // Offline fallback model lists (kept up-to-date)
        const _offlineModelLists = {
            anthropic: [
                'claude-opus-4-6','claude-opus-4-5-20250514','claude-opus-4-5',
                'claude-sonnet-4-5-20250514','claude-sonnet-4-5',
                'claude-sonnet-4-20250514','claude-sonnet-4',
                'claude-3-5-sonnet-20241022','claude-3-5-haiku-20241022','claude-3-opus-20240229',
            ],
            openai: [
                'gpt-4o','gpt-4o-mini','gpt-4-turbo','gpt-4',
                'gpt-4o-2024-08-06','o1','o1-mini','o1-preview',
                'o3','o3-mini','o4-mini','gpt-4.1','gpt-4.1-mini','gpt-4.1-nano',
            ],
            deepseek: ['deepseek-chat','deepseek-coder','deepseek-reasoner'],
            gemini: [
                'gemini/gemini-2.5-pro-preview-05-06','gemini/gemini-2.5-flash-preview-04-17',
                'gemini/gemini-2.0-flash','gemini/gemini-2.0-flash-lite',
                'gemini/gemini-1.5-pro','gemini/gemini-1.5-flash',
            ],
            groq: [
                'groq/llama-3.3-70b-versatile','groq/llama-3.1-8b-instant',
                'groq/llama-3.1-70b-versatile','groq/mixtral-8x7b-32768',
                'groq/gemma2-9b-it','groq/deepseek-r1-distill-llama-70b','groq/whisper-large-v3',
            ],
            openrouter: [
                'anthropic/claude-opus-4-5','anthropic/claude-sonnet-4-5','anthropic/claude-sonnet-4',
                'openai/gpt-4o','openai/gpt-4o-mini','openai/o3','openai/o3-mini','openai/o4-mini',
                'google/gemini-2.5-pro-preview','google/gemini-2.5-flash-preview','google/gemini-2.0-flash-001',
                'deepseek/deepseek-chat','deepseek/deepseek-reasoner',
                'meta-llama/llama-3.3-70b-instruct','qwen/qwen-2.5-72b-instruct','mistralai/mistral-large-2411',
            ],
            aihubmix: ['claude-opus-4-5-20250514','claude-sonnet-4-5-20250514','gpt-4o','gpt-4o-mini','deepseek-chat','gemini-2.0-flash'],
            siliconflow: ['deepseek-ai/DeepSeek-V3','deepseek-ai/DeepSeek-R1','Qwen/Qwen2.5-72B-Instruct','Qwen/Qwen2.5-7B-Instruct','meta-llama/Meta-Llama-3.1-70B-Instruct'],
            volcengine: ['doubao-1.5-pro-32k','doubao-1.5-lite-32k','doubao-pro-256k','deepseek-v3','deepseek-r1'],
            dashscope: ['qwen-max','qwen-plus','qwen-turbo','qwen-long','qwen2.5-72b-instruct','qwen2.5-14b-instruct','qwen2.5-coder-32b-instruct'],
            zhipu: ['glm-4-plus','glm-4-long','glm-4-flash','glm-4-air','glm-4'],
            moonshot: ['kimi-k2.5','moonshot-v1-128k','moonshot-v1-32k','moonshot-v1-8k'],
            minimax: ['MiniMax-Text-01','MiniMax-M1','abab6.5s-chat','abab6.5-chat'],
            vllm: [],
            openai_codex: ['openai-codex/codex-mini-latest','openai-codex/o4-mini','openai-codex/o3','openai-codex/gpt-4o'],
            github_copilot: ['github_copilot/gpt-4o','github_copilot/gpt-4o-mini','github_copilot/claude-3.5-sonnet','github_copilot/o3-mini'],
            custom: [],
        };

        function renderModelDropdown(models, filter) {
            const dd = document.getElementById('modelDropdown');
            if (!dd) return;
            const q = (filter || '').toLowerCase();
            const filtered = q ? models.filter(m => m.toLowerCase().includes(q)) : models;
            if (filtered.length === 0) {
                dd.innerHTML = '<div style="padding:10px 14px;color:var(--text-muted);font-size:13px;">No matching models. Type any model name.</div>';
            } else {
                dd.innerHTML = filtered.map(m => `<div class="model-option" style="padding:8px 14px;cursor:pointer;font-size:13px;font-family:\'JetBrains Mono\',monospace;border-bottom:1px solid var(--border-light);transition:background 0.1s;" onmousedown="selectModel('${m.replace(/'/g, "\\'")}')" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background=''">${m}</div>`).join('');
            }
        }

        function selectModel(model) {
            const input = document.getElementById('agentModel');
            if (input) input.value = model;
            hideModelDropdown();
            syncConfig();
        }

        function showModelDropdown() {
            const dd = document.getElementById('modelDropdown');
            if (!dd) return;
            const input = document.getElementById('agentModel');
            const filter = input ? input.value : '';
            if (_currentModels.length > 0) {
                renderModelDropdown(_currentModels, filter);
                dd.style.display = 'block';
                _modelDropdownVisible = true;
            } else {
                // Try loading models for current provider
                const provider = document.getElementById('agentProvider')?.value;
                if (provider) loadModelsForProvider(provider).then(() => {
                    if (_currentModels.length > 0) {
                        renderModelDropdown(_currentModels, filter);
                        dd.style.display = 'block';
                        _modelDropdownVisible = true;
                    }
                });
            }
        }

        function hideModelDropdown() {
            const dd = document.getElementById('modelDropdown');
            if (dd) dd.style.display = 'none';
            _modelDropdownVisible = false;
        }

        function onModelInput() {
            const input = document.getElementById('agentModel');
            const filter = input ? input.value : '';
            if (_currentModels.length > 0) {
                renderModelDropdown(_currentModels, filter);
                const dd = document.getElementById('modelDropdown');
                if (dd) dd.style.display = 'block';
            }
            syncConfig();
        }

        // Close agent-config dropdown on outside click
        document.addEventListener('click', (e) => {
            const combo = document.getElementById('modelCombo');
            if (combo && !combo.contains(e.target)) hideModelDropdown();
            // Close chat dropdown
            const chatInput = document.getElementById('chatModel');
            const chatDd = document.getElementById('chatModelDropdown');
            if (chatInput && chatDd && !chatInput.contains(e.target) && !chatDd.contains(e.target)) {
                chatDd.style.display = 'none';
            }
            // Close wizard dropdown
            const wizInput = document.getElementById('wizardModel');
            const wizDd = document.getElementById('wizardModelDropdown');
            if (wizInput && wizDd && !wizInput.contains(e.target) && !wizDd.contains(e.target)) {
                wizDd.style.display = 'none';
            }
        });

        // ============================================================
        // CHAT PAGE ‚Äî model combo-box
        // ============================================================
        let _chatModels = [];

        async function onChatProviderChange() {
            const provider = document.getElementById('chatProvider')?.value;
            if (!provider) return;
            await _loadChatModels(provider);
        }

        async function _loadChatModels(provider) {
            const loading = document.getElementById('chatModelLoading');
            const hint    = document.getElementById('chatModelHint');
            if (loading) loading.style.display = '';

            // Re-use agent-config cache
            if (_modelCache[provider]) {
                _chatModels = _modelCache[provider];
                if (hint) hint.textContent = `${_chatModels.length} models available`;
                if (loading) loading.style.display = 'none';
                return;
            }

            if (NanobotAPI.connected) {
                try {
                    const result = await NanobotAPI.fetchModels(provider);
                    if (result && result.models && result.models.length > 0) {
                        _modelCache[provider] = result.models;
                        _chatModels = result.models;
                        const liveTag = result.live ? ' (live)' : '';
                        if (hint) hint.textContent = `${_chatModels.length} models${liveTag}`;
                    } else {
                        _chatModels = _offlineModelLists[provider] || [];
                        if (hint) hint.textContent = `${_chatModels.length} models (offline)`;
                    }
                } catch (_) {
                    _chatModels = _offlineModelLists[provider] || [];
                    if (hint) hint.textContent = 'Type any model name.';
                }
            } else {
                _chatModels = _offlineModelLists[provider] || [];
                if (hint) hint.textContent = _chatModels.length > 0 ? `${_chatModels.length} models (offline)` : 'Type any model name.';
            }

            if (loading) loading.style.display = 'none';
        }

        function _renderChatDropdown(filter) {
            const dd = document.getElementById('chatModelDropdown');
            if (!dd) return;
            const q = (filter || '').toLowerCase();
            const list = q ? _chatModels.filter(m => m.toLowerCase().includes(q)) : _chatModels;
            if (list.length === 0) {
                dd.innerHTML = '<div style="padding:8px 14px;color:var(--text-muted);font-size:13px;">No matches. Type any model name.</div>';
            } else {
                dd.innerHTML = list.map(m =>
                    `<div style="padding:8px 14px;cursor:pointer;font-size:13px;font-family:\'JetBrains Mono\',monospace;border-bottom:1px solid var(--border-light);" onmousedown="selectChatModel('${m.replace(/'/g,"\\'")}')" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background=''">${m}</div>`
                ).join('');
            }
        }

        function selectChatModel(model) {
            const inp = document.getElementById('chatModel');
            if (inp) inp.value = model;
            const dd = document.getElementById('chatModelDropdown');
            if (dd) dd.style.display = 'none';
        }

        function showChatModelDropdown() {
            const inp = document.getElementById('chatModel');
            const dd  = document.getElementById('chatModelDropdown');
            if (!dd) return;
            const filter = inp ? inp.value : '';
            if (_chatModels.length === 0) {
                const provider = document.getElementById('chatProvider')?.value || 'anthropic';
                _loadChatModels(provider).then(() => {
                    if (_chatModels.length > 0) {
                        _renderChatDropdown(filter);
                        dd.style.display = 'block';
                    }
                });
            } else {
                _renderChatDropdown(filter);
                dd.style.display = 'block';
            }
        }

        function onChatModelInput() {
            const inp = document.getElementById('chatModel');
            const dd  = document.getElementById('chatModelDropdown');
            if (!dd) return;
            const filter = inp ? inp.value : '';
            if (_chatModels.length > 0) {
                _renderChatDropdown(filter);
                dd.style.display = 'block';
            }
        }

        // ============================================================
        // SETUP WIZARD ‚Äî model combo-box
        // ============================================================
        let _wizardModels = [];

        // Called from wizardSelectProvider so the wizard model list follows the selected pill
        async function _loadWizardModels(provider) {
            if (_modelCache[provider]) {
                _wizardModels = _modelCache[provider];
                return;
            }
            if (NanobotAPI.connected) {
                try {
                    const result = await NanobotAPI.fetchModels(provider);
                    if (result && result.models && result.models.length > 0) {
                        _modelCache[provider] = result.models;
                        _wizardModels = result.models;
                        return;
                    }
                } catch (_) {}
            }
            _wizardModels = _offlineModelLists[provider] || [];
        }

        function _renderWizardDropdown(filter) {
            const dd = document.getElementById('wizardModelDropdown');
            if (!dd) return;
            const q = (filter || '').toLowerCase();
            const list = q ? _wizardModels.filter(m => m.toLowerCase().includes(q)) : _wizardModels;
            if (list.length === 0) {
                dd.innerHTML = '<div style="padding:8px 14px;color:var(--text-muted);font-size:13px;">Type any model name.</div>';
            } else {
                dd.innerHTML = list.map(m =>
                    `<div style="padding:8px 14px;cursor:pointer;font-size:13px;font-family:\'JetBrains Mono\',monospace;border-bottom:1px solid var(--border-light);background:var(--bg-surface);" onmousedown="selectWizardModel('${m.replace(/'/g,"\\'")}')" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='var(--bg-surface)'">${m}</div>`
                ).join('');
            }
        }

        function selectWizardModel(model) {
            const inp = document.getElementById('wizardModel');
            if (inp) inp.value = model;
            const dd = document.getElementById('wizardModelDropdown');
            if (dd) dd.style.display = 'none';
        }

        function showWizardModelDropdown() {
            const inp = document.getElementById('wizardModel');
            const dd  = document.getElementById('wizardModelDropdown');
            if (!dd) return;
            const filter = inp ? inp.value : '';
            if (_wizardModels.length === 0) {
                const pill = document.querySelector('.provider-pill.selected');
                const provider = pill ? pill.dataset.provider : 'openrouter';
                _loadWizardModels(provider).then(() => {
                    if (_wizardModels.length > 0) {
                        _renderWizardDropdown(filter);
                        dd.style.display = 'block';
                    }
                });
            } else {
                _renderWizardDropdown(filter);
                dd.style.display = 'block';
            }
        }

        function onWizardModelInput() {
            const inp = document.getElementById('wizardModel');
            const dd  = document.getElementById('wizardModelDropdown');
            if (!dd) return;
            const filter = inp ? inp.value : '';
            if (_wizardModels.length > 0) {
                _renderWizardDropdown(filter);
                dd.style.display = 'block';
            }
        }

        // --- Populate Agent Config Form from state ---
        function populateAgentConfigForm() {
            const c = state.agentConfig;
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            set('agentName', c.name);
            set('agentVersion', c.version);
            set('agentWorkspace', c.workspace);
            set('agentProvider', c.provider);
            set('agentModel', c.model);
            set('agentTemperature', c.temperature);
            set('agentMaxTokens', c.max_tokens);
            set('agentMaxIterations', c.max_iterations);
            set('agentMemoryWindow', c.memory_window);
            set('agentSystemPrompt', c.system_prompt);
            const tempVal = document.getElementById('tempValue');
            if (tempVal) tempVal.textContent = c.temperature;
            // Memory
            const memEl = document.getElementById('memoryContent');
            if (memEl && state.memory) memEl.value = state.memory;
            // Load models for the selected provider
            const provider = c.provider || document.getElementById('agentProvider')?.value;
            if (provider) loadModelsForProvider(provider);
        }

        // --- On field change: persist immediately + save to backend ---
        function onFieldChange(dataKey, id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (!card) return;
            if (!state[dataKey][id]) state[dataKey][id] = { enabled: false, fields: {} };
            state[dataKey][id].fields = collectCardFields(card);
            saveState();
            syncConfig();
            emitEvent('fieldChange', { dataKey, id, fields: state[dataKey][id].fields });
            // Auto-save to backend
            if (NanobotAPI.connected) {
                saveToBackend(dataKey, id);
            }
        }

        // --- Save a single item to backend config.json ---
        function saveToBackend(dataKey, id) {
            const s = state[dataKey][id];
            if (!s) return;
            if (dataKey === 'providers') {
                // Invalidate model cache so next fetch gets live models with new key
                delete _modelCache[id];
                NanobotAPI.saveProviderConfig(id, {
                    apiKey: s.fields?.api_key || '',
                    apiBase: s.fields?.base_url || null,
                });
            } else if (dataKey === 'channels') {
                const channelData = { enabled: s.enabled || false };
                if (s.fields) {
                    for (const [k, v] of Object.entries(s.fields)) {
                        const camel = k.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
                        if (k === 'allow_from' && typeof v === 'string') {
                            channelData[camel] = v.split(',').map(x => x.trim()).filter(Boolean);
                        } else {
                            channelData[camel] = v;
                        }
                    }
                }
                NanobotAPI.saveChannelConfig(id, channelData);
            } else if (dataKey === 'tools') {
                saveToolsToBackend();
            }
        }

        // --- Save full tools config to backend ---
        async function saveToolsToBackend() {
            if (!NanobotAPI.connected) return;
            // Use PATCH to only update the specific fields that changed
            const patch = { tools: {} };
            const shellState = state.tools.shell;
            if (shellState?.fields?.timeout) {
                patch.tools.exec = { timeout: parseInt(shellState.fields.timeout) || 60 };
            }
            const wsState = state.tools.websearch;
            if (wsState?.fields?.api_key) {
                patch.tools.web = { search: { apiKey: wsState.fields.api_key } };
            }
            const result = await NanobotAPI.patchConfig(patch);
            if (result?.ok) {
                toast('Tools config saved');
            }
        }

        // --- Save agent config to backend ---
        function saveAgentConfigToBackend() {
            if (!NanobotAPI.connected) return;
            readAgentConfigForm();
            const c = state.agentConfig;
            NanobotAPI.saveAgentConfig({
                defaults: {
                    workspace: c.workspace || '~/.nanobot/workspace',
                    model: c.model || 'anthropic/claude-opus-4-5',
                    maxTokens: parseInt(c.max_tokens) || 8192,
                    temperature: parseFloat(c.temperature) || 0.7,
                    maxToolIterations: parseInt(c.max_iterations) || 20,
                    memoryWindow: parseInt(c.memory_window) || 50,
                }
            });
            toast('Agent config saved to config.json');
        }

        // --- Restart agent loop ---
        async function restartAgent() {
            if (!NanobotAPI.connected) {
                toast('Not connected to backend');
                return;
            }
            toast('Restarting agent...');
            const result = await NanobotAPI.restartAgent();
            if (result?.ok) {
                toast('Agent restarted successfully');
            } else {
                toast('Failed to restart agent');
            }
        }

        // --- Save all config to backend at once ---
        async function saveAllToBackend() {
            if (!NanobotAPI.connected) {
                toast('Not connected to backend');
                return;
            }
            readAgentConfigForm();
            const c = state.agentConfig;
            const configData = {
                agents: {
                    defaults: {
                        workspace: c.workspace || '~/.nanobot/workspace',
                        model: c.model || 'anthropic/claude-opus-4-5',
                        maxTokens: parseInt(c.max_tokens) || 8192,
                        temperature: parseFloat(c.temperature) || 0.7,
                        maxToolIterations: parseInt(c.max_iterations) || 20,
                        memoryWindow: parseInt(c.memory_window) || 50,
                    }
                },
                providers: {},
                channels: {},
                tools: { exec: { timeout: 60 }, web: { search: { apiKey: '', maxResults: 5 } }, restrictToWorkspace: false, mcpServers: {} },
            };
            // Build providers
            providers.forEach(p => {
                const ps = state.providers[p.id];
                configData.providers[p.id] = {
                    apiKey: ps?.fields?.api_key || '',
                    apiBase: ps?.fields?.base_url || null,
                };
            });
            // Build channels
            channels.forEach(ch => {
                const cs = state.channels[ch.id];
                const chData = { enabled: cs?.enabled || false };
                if (cs?.fields) {
                    for (const [k, v] of Object.entries(cs.fields)) {
                        const camel = k.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
                        if (k === 'allow_from' && typeof v === 'string') {
                            chData[camel] = v.split(',').map(x => x.trim()).filter(Boolean);
                        } else {
                            chData[camel] = v;
                        }
                    }
                }
                configData.channels[ch.id] = chData;
            });
            // Tools
            const shellState = state.tools.shell;
            if (shellState?.fields?.timeout) configData.tools.exec.timeout = parseInt(shellState.fields.timeout) || 60;
            const wsState = state.tools.websearch;
            if (wsState?.fields?.api_key) configData.tools.web.search.apiKey = wsState.fields.api_key;

            const result = await NanobotAPI.fetch('/api/config', {
                method: 'PUT',
                body: JSON.stringify(configData),
            });
            if (result?.ok) {
                toast('All configuration saved to config.json');
            } else {
                toast('Failed to save configuration');
            }
        }

        // --- Toggle Functions ---
        function toggleProvider(id) {
            if (!state.providers[id]) state.providers[id] = { enabled: false, fields: {} };
            state.providers[id].enabled = !state.providers[id].enabled;
            renderProviders();
            updateStats();
            saveState();
            syncConfig();
            emitEvent('toggleProvider', { id, enabled: state.providers[id].enabled });
            if (NanobotAPI.connected) saveToBackend('providers', id);
        }

        async function startProviderOAuth(providerId) {
            if (!NanobotAPI.connected) {
                toast('Not connected to backend');
                return;
            }

            const statusEl = document.getElementById(`oauthStatus_${providerId}`);
            if (!statusEl) return;

            // First check current status
            const currentStatus = await NanobotAPI.oauthStatus(providerId);
            if (currentStatus && currentStatus.authenticated) {
                statusEl.innerHTML = '<span style="color:var(--success-600);font-weight:600;">Already authenticated</span>' +
                    (currentStatus.accountId ? ` ‚Äî ${currentStatus.accountId}` : '');
                return;
            }

            statusEl.innerHTML = 'Starting OAuth flow...';
            const result = await NanobotAPI.oauthStart(providerId);
            if (!result) {
                statusEl.innerHTML = '<span style="color:var(--danger-600);">Failed to start OAuth flow</span>';
                return;
            }

            if (providerId === 'openai_codex') {
                const url = result.authUrl;
                statusEl.innerHTML =
                    '<strong>1.</strong> <a href="' + url + '" target="_blank" style="color:var(--primary-600);">Click here to log in with OpenAI</a><br>' +
                    '<strong>2.</strong> Paste the callback URL below:<br>' +
                    '<input type="text" id="oauthCodeInput_' + providerId + '" placeholder="Paste callback URL or code..." ' +
                    'style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:12px;margin:6px 0;">' +
                    '<button class="btn btn-primary" style="font-size:11px;padding:4px 12px;" ' +
                    'onclick="submitProviderOAuth(\'' + providerId + '\')">Submit</button>';
            } else if (providerId === 'github_copilot') {
                let html = '';
                if (result.deviceUrl) {
                    html += 'Open: <a href="' + result.deviceUrl + '" target="_blank" style="color:var(--primary-600);">' + result.deviceUrl + '</a><br>';
                }
                if (result.deviceCode) {
                    html += 'Code: <code style="font-size:14px;font-weight:700;letter-spacing:1px;">' + result.deviceCode + '</code><br>';
                }
                if (result.done) {
                    html += '<span style="color:var(--success-600);font-weight:600;">Authenticated!</span>';
                } else {
                    html += '<button class="btn btn-secondary" style="font-size:11px;padding:4px 12px;margin-top:4px;" ' +
                        'onclick="startProviderOAuth(\'' + providerId + '\')">Check Status</button>';
                }
                if (result.output && result.output.length) {
                    html += '<details style="margin-top:4px;"><summary style="cursor:pointer;font-size:11px;color:var(--text-muted);">Output</summary>' +
                        '<pre style="font-size:10px;max-height:100px;overflow:auto;padding:6px;background:var(--bg-base);border-radius:4px;">' +
                        result.output.join('\n') + '</pre></details>';
                }
                statusEl.innerHTML = html;
            }
        }

        async function submitProviderOAuth(providerId) {
            const input = document.getElementById(`oauthCodeInput_${providerId}`);
            const statusEl = document.getElementById(`oauthStatus_${providerId}`);
            if (!input || !input.value.trim()) {
                toast('Please paste the callback URL or code');
                return;
            }

            statusEl.innerHTML += '<br>Verifying...';
            const result = await NanobotAPI.oauthCallback(providerId, input.value.trim());

            if (result && result.authenticated) {
                statusEl.innerHTML = '<span style="color:var(--success-600);font-weight:600;">Authenticated!</span>' +
                    (result.accountId ? ` ‚Äî ${result.accountId}` : '');
                // Enable provider
                if (!state.providers[providerId]) state.providers[providerId] = { enabled: false, fields: {} };
                state.providers[providerId].enabled = true;
                toast(providerId.replace(/_/g, ' ') + ' authenticated');
                setTimeout(() => { renderProviders(); updateStats(); saveState(); syncConfig(); }, 1000);
            } else {
                statusEl.innerHTML += '<br><span style="color:var(--danger-600);">' + (result?.error || 'Failed') + '</span>';
            }
        }

        function toggleChannel(id) {
            const channel = channels.find(c => c.id === id);
            if (channel && !channel.alwaysEnabled) {
                if (!state.channels[id]) state.channels[id] = { enabled: false, fields: {} };
                state.channels[id].enabled = !state.channels[id].enabled;
                renderChannels();
                updateStats();
                saveState();
                syncConfig();
                emitEvent('toggleChannel', { id, enabled: state.channels[id].enabled });
                if (NanobotAPI.connected) saveToBackend('channels', id);
            }
        }

        function toggleTool(id) {
            if (!state.tools[id]) state.tools[id] = { enabled: false, fields: {} };
            state.tools[id].enabled = !state.tools[id].enabled;
            renderTools();
            updateStats();
            saveState();
            syncConfig();
            emitEvent('toggleTool', { id, enabled: state.tools[id].enabled });
        }

        function toggleSkill(index) {
            if (state.skills[index]) {
                state.skills[index].enabled = !state.skills[index].enabled;
                renderSkillsTable();
                saveState();
                emitEvent('toggleSkill', { index, skill: state.skills[index] });
            }
        }

        function toggleCronJob(index) {
            if (state.cronJobs[index]) {
                state.cronJobs[index].active = !state.cronJobs[index].active;
                renderCronTable();
                saveState();
                emitEvent('toggleCronJob', { index, job: state.cronJobs[index] });
            }
        }

        // --- Filter Providers ---
        function filterProviders(query) {
            const cards = document.querySelectorAll('.provider-card');
            cards.forEach(card => {
                const name = card.querySelector('.provider-name').textContent.toLowerCase();
                card.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Update Stats ---
        function updateStats() {
            const enabledProviders = Object.values(state.providers).filter(p => p.enabled).length;
            const enabledChannels = Object.values(state.channels).filter(c => c.enabled).length + 1;
            const enabledTools = Object.values(state.tools).filter(t => t.enabled).length;
            const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
            el('statProviders', `${enabledProviders}/${providers.length}`);
            el('statChannels', `${enabledChannels}/${channels.length}`);
            el('statTools', `${enabledTools}/${tools.length}`);
            el('statSkills', String(state.skills.length));
        }

        // --- Read agent config from form ---
        function readAgentConfigForm() {
            const g = (id, def) => { const el = document.getElementById(id); return el ? el.value : def; };
            state.agentConfig = {
                name: g('agentName', 'nanobot-assistant'),
                version: g('agentVersion', '0.1.4.post1'),
                workspace: g('agentWorkspace', '/workspace/nanobot'),
                model: g('agentModel', 'claude-opus-4-6'),
                provider: g('agentProvider', 'anthropic'),
                temperature: parseFloat(g('agentTemperature', '0.7')),
                max_tokens: parseInt(g('agentMaxTokens', '4096')),
                max_iterations: parseInt(g('agentMaxIterations', '15')),
                memory_window: parseInt(g('agentMemoryWindow', '10')),
                system_prompt: g('agentSystemPrompt', '')
            };
        }

        // --- Config Management ---
        function buildConfig() {
            readAgentConfigForm();
            const providerConfigs = {};
            providers.forEach(p => {
                const ps = state.providers[p.id];
                if (ps && ps.enabled) {
                    providerConfigs[p.id] = { ...ps.fields };
                    if (p.promptCaching && ps.fields?.enable_prompt_caching) {
                        providerConfigs[p.id].prompt_caching = true;
                    }
                }
            });
            const channelConfigs = {};
            channels.forEach(c => {
                const cs = state.channels[c.id];
                if ((cs && cs.enabled) || c.alwaysEnabled) {
                    channelConfigs[c.id] = { ...cs?.fields };
                }
            });
            const toolConfigs = {};
            tools.forEach(t => {
                const ts = state.tools[t.id];
                if (ts && ts.enabled) {
                    toolConfigs[t.id] = { ...ts.fields };
                }
            });
            return {
                agent: { ...state.agentConfig },
                providers: providerConfigs,
                channels: channelConfigs,
                tools: toolConfigs,
                skills: state.skills.filter(s => s.enabled).map(s => ({ name: s.name, summary: s.summary })),
                cron_jobs: state.cronJobs,
                mcp_servers: state.mcpServers,
                subagents: state.subagents
            };
        }

        function syncConfig() {
            const config = buildConfig();
            const preview = document.getElementById('configPreview');
            if (preview) preview.innerHTML = formatJSON(config, 0);
        }

        function formatJSON(obj, indent) {
            const spaces = '  '.repeat(indent);
            if (typeof obj !== 'object' || obj === null) {
                if (typeof obj === 'string') return `<span class="json-string">"${obj}"</span>`;
                if (typeof obj === 'number') return `<span class="json-number">${obj}</span>`;
                if (typeof obj === 'boolean') return `<span class="json-boolean">${obj}</span>`;
                return `<span class="json-null">null</span>`;
            }
            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                const items = obj.map(item => `${spaces}  ${formatJSON(item, indent + 1)}`).join(',\n');
                return `[\n${items}\n${spaces}]`;
            }
            const keys = Object.keys(obj);
            if (keys.length === 0) return '{}';
            const items = keys.map(key => `${spaces}  <span class="json-key">"${key}"</span>: ${formatJSON(obj[key], indent + 1)}`).join(',\n');
            return `{\n${items}\n${spaces}}`;
        }

        function exportConfig() {
            if (NanobotAPI.connected) {
                window.location.href = '/api/config/export';
                toast('Config exported');
                return;
            }
            const config = buildConfig();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'nanobot-config.json'; a.click();
            URL.revokeObjectURL(url);
            toast('Configuration exported');
            emitEvent('exportConfig', { config });
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    applyConfig(config);
                    toast('Configuration imported successfully');
                    emitEvent('importConfig', { config });
                } catch (err) {
                    toast('Invalid JSON file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function applyConfig(config) {
            // Agent config
            if (config.agent) {
                Object.assign(state.agentConfig, config.agent);
            }
            // Providers
            if (config.providers) {
                if (Array.isArray(config.providers)) {
                    config.providers.forEach(id => {
                        if (!state.providers[id]) state.providers[id] = { enabled: false, fields: {} };
                        state.providers[id].enabled = true;
                    });
                } else {
                    Object.entries(config.providers).forEach(([id, fields]) => {
                        state.providers[id] = { enabled: true, fields: fields || {} };
                    });
                }
            }
            // Channels
            if (config.channels) {
                if (Array.isArray(config.channels)) {
                    config.channels.forEach(id => {
                        if (id !== 'cli') {
                            if (!state.channels[id]) state.channels[id] = { enabled: false, fields: {} };
                            state.channels[id].enabled = true;
                        }
                    });
                } else {
                    Object.entries(config.channels).forEach(([id, fields]) => {
                        if (id !== 'cli') state.channels[id] = { enabled: true, fields: fields || {} };
                    });
                }
            }
            // Tools
            if (config.tools) {
                if (Array.isArray(config.tools)) {
                    config.tools.forEach(id => {
                        if (!state.tools[id]) state.tools[id] = { enabled: false, fields: {} };
                        state.tools[id].enabled = true;
                    });
                } else {
                    Object.entries(config.tools).forEach(([id, fields]) => {
                        state.tools[id] = { enabled: true, fields: fields || {} };
                    });
                }
            }
            // Skills
            if (config.skills) state.skills = config.skills.map(s => ({ ...s, enabled: s.enabled !== false }));
            // Cron
            if (config.cron_jobs) state.cronJobs = config.cron_jobs;
            // MCP
            if (config.mcp_servers) state.mcpServers = config.mcp_servers;
            // Subagents
            if (config.subagents) state.subagents = config.subagents;

            // Re-render everything
            populateAgentConfigForm();
            renderProviders();
            renderChannels();
            renderTools();
            renderSkillsTable();
            renderCronTable();
            renderSubagents();
            updateStats();
            syncConfig();
            saveState();
        }

        function copyConfig() {
            const config = buildConfig();
            navigator.clipboard.writeText(JSON.stringify(config, null, 2));
            toast('Configuration copied to clipboard');
        }

        // --- Slider Update ---
        function updateSlider(slider) {
            document.getElementById('tempValue').textContent = slider.value;
            state.agentConfig.temperature = parseFloat(slider.value);
            syncConfig();
            saveState();
        }

        // --- Tab Switching ---
        function switchTab(section, index, element) {
            const tabs = element.parentElement.querySelectorAll('.tab');
            const contents = element.parentElement.parentElement.querySelectorAll('.tab-content');
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            contents[index].classList.add('active');
        }

        // --- Modal Management ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- Add/Remove Skills ---
        function addSkill(name, summary, content) {
            name = name || document.getElementById('newSkillName')?.value;
            summary = summary || document.getElementById('newSkillSummary')?.value;
            if (!name || !summary) { toast('Please fill in all fields'); return; }
            state.skills.push({ name, summary, enabled: true, content: content || '' });
            renderSkillsTable();
            updateStats();
            saveState();
            closeModal('addSkillModal');
            toast(`Skill "${name}" added`);
            if (document.getElementById('newSkillName')) document.getElementById('newSkillName').value = '';
            if (document.getElementById('newSkillSummary')) document.getElementById('newSkillSummary').value = '';
            emitEvent('addSkill', { name, summary });
        }

        function removeSkill(index) {
            const removed = state.skills.splice(index, 1)[0];
            renderSkillsTable();
            updateStats();
            saveState();
            toast(`Skill "${removed?.name}" removed`);
            emitEvent('removeSkill', { index, skill: removed });
        }

        function viewSkill(index) {
            const skill = state.skills[index];
            if (skill) alert(`Skill: ${skill.name}\n\n${skill.content || skill.summary}`);
        }

        // --- Add/Remove Cron Jobs ---
        function addCronJob(schedule, task) {
            schedule = schedule || document.getElementById('newCronSchedule')?.value;
            task = task || document.getElementById('newCronTask')?.value;
            if (!schedule || !task) { toast('Please fill in all fields'); return; }
            const id = 'job_' + String(state.cronJobs.length + 1).padStart(3, '0');
            state.cronJobs.push({ id, schedule, task, active: true, lastRun: '-', nextRun: 'Calculating...' });
            renderCronTable();
            saveState();
            closeModal('addCronModal');
            toast(`Cron job "${id}" added`);
            if (document.getElementById('newCronSchedule')) document.getElementById('newCronSchedule').value = '';
            if (document.getElementById('newCronTask')) document.getElementById('newCronTask').value = '';
            emitEvent('addCronJob', { id, schedule, task });
        }

        function removeCronJob(index) {
            const removed = state.cronJobs.splice(index, 1)[0];
            renderCronTable();
            saveState();
            toast(`Cron job "${removed?.id}" removed`);
            emitEvent('removeCronJob', { index, job: removed });
        }

        // --- Add/Remove MCP Servers ---
        function addMcpServer(name, command, args, authHeader) {
            name = name || document.getElementById('newMcpName')?.value;
            command = command || document.getElementById('newMcpCommand')?.value;
            args = args || document.getElementById('newMcpArgs')?.value;
            authHeader = authHeader || document.getElementById('newMcpAuth')?.value;
            if (!name) { toast('Server name is required'); return; }
            state.mcpServers.push({ name, command: command || '', args: args || '', authHeader: authHeader || '' });
            renderTools();
            saveState();
            closeModal('addMcpModal');
            toast(`MCP server "${name}" added`);
            ['newMcpName','newMcpCommand','newMcpArgs','newMcpAuth'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            emitEvent('addMcpServer', { name, command });
        }

        function removeMcpServer(index) {
            const removed = state.mcpServers.splice(index, 1)[0];
            renderTools();
            saveState();
            toast(`MCP server "${removed?.name}" removed`);
            emitEvent('removeMcpServer', { index, server: removed });
        }

        // --- Save Memory ---
        function saveMemory() {
            const content = document.getElementById('memoryContent')?.value || '';
            state.memory = content;
            saveState();
            emitEvent('saveMemory', { content });
            if (NanobotAPI.connected) {
                NanobotAPI.saveMemory(content);
                toast('Memory saved to MEMORY.md');
            } else {
                toast('Memory saved locally');
            }
        }

        // --- Chat Functions ---
        const agentResponses = [
            "I understand. Let me help you with that.",
            "That's a great question. Here's what I think...",
            "I can definitely assist with that task.",
            "Let me process that information for you.",
            "Based on your request, I recommend...",
            "I've analyzed your query and here's my response.",
            "That's an interesting use case. Let me explain...",
            "I can help you configure that. Here are the steps..."
        ];

        function sendChat(messageText) {
            const input = document.getElementById('chatInput');
            const message = messageText || input?.value?.trim();
            if (!message) return;
            const messages = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            messages.appendChild(userMsg);
            if (input) input.value = '';
            messages.scrollTop = messages.scrollHeight;
            emitEvent('chatMessage', { role: 'user', message });

            if (NanobotAPI.connected) {
                NanobotAPI.connectChat();
                NanobotAPI.sendChatMessage(message);
                return;
            }

            setTimeout(() => {
                const resp = agentResponses[Math.floor(Math.random() * agentResponses.length)];
                const agentMsg = document.createElement('div');
                agentMsg.className = 'chat-message agent';
                agentMsg.textContent = resp;
                messages.appendChild(agentMsg);
                messages.scrollTop = messages.scrollHeight;
                emitEvent('chatMessage', { role: 'agent', message: resp });
            }, 1000);
        }

        function clearChat() {
            const messages = document.getElementById('chatMessages');
            if (messages) messages.innerHTML = `
                <div class="chat-message system">Chat session started. Type a message to begin.</div>
                <div class="chat-message agent">Hello! I'm your Nanobot assistant. How can I help you today?</div>
            `;
        }

        // --- Toast Notification ---
        function toast(message) {
            const container = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<div class="toast-message">${message}</div>`;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- State Persistence ---
        function saveState() {
            readAgentConfigForm();
            const memEl = document.getElementById('memoryContent');
            if (memEl) state.memory = memEl.value;
            localStorage.setItem('nanobot-state', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('nanobot-state');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Deep merge
                Object.keys(parsed).forEach(k => {
                    if (typeof parsed[k] === 'object' && !Array.isArray(parsed[k]) && parsed[k] !== null) {
                        state[k] = { ...(state[k] || {}), ...parsed[k] };
                    } else {
                        state[k] = parsed[k];
                    }
                });
            }
            // Defaults
            if (!state.skills || state.skills.length === 0) {
                state.skills = [
                    { name: 'web-search', summary: 'Search the web for information', enabled: true, content: '' },
                    { name: 'code-review', summary: 'Analyze code for issues and improvements', enabled: true, content: '' },
                    { name: 'data-analysis', summary: 'Process and analyze data', enabled: true, content: '' }
                ];
            }
            if (!state.cronJobs || state.cronJobs.length === 0) {
                state.cronJobs = [
                    { id: 'job_001', schedule: '0 9 * * *', task: 'Daily backup of memory files', active: true, lastRun: 'Today 09:00', nextRun: 'Tomorrow 09:00' },
                    { id: 'job_002', schedule: '*/30 * * * *', task: 'Check for new messages in email channel', active: true, lastRun: '14:30', nextRun: '15:00' },
                    { id: 'job_003', schedule: '0 0 * * 0', task: 'Weekly system health report', active: true, lastRun: 'Last Sunday', nextRun: 'Next Sunday' }
                ];
            }
            if (!state.subagents || state.subagents.length === 0) {
                state.subagents = [
                    { name: 'subagent-researcher', task: 'Research latest AI trends', status: 'running', iteration: 9, maxIterations: 15 },
                    { name: 'subagent-coder', task: 'Implement authentication module', status: 'running', iteration: 5, maxIterations: 15 },
                    { name: 'subagent-reviewer', task: 'Code review for PR #42', status: 'running', iteration: 12, maxIterations: 15 },
                    { name: 'subagent-tester', task: 'Run integration tests', status: 'completed', iteration: 15, maxIterations: 15 }
                ];
            }
            if (!state.mcpServers) state.mcpServers = [];
            if (!state.activityLog) state.activityLog = [];
            if (!state.customPages) state.customPages = {};
            if (!state.agentConfig) state.agentConfig = {};
        }

        // ============================================================
        // PUBLIC API ‚Äî window.NanobotDashboard
        // ============================================================
        // The bot or any external script can use this API to
        // programmatically modify the dashboard.
        // ============================================================
        window.NanobotDashboard = {
            // --- State Access ---
            getState: () => JSON.parse(JSON.stringify(state)),
            getConfig: () => buildConfig(),

            // --- Provider CRUD ---
            addProvider: (opts) => {
                // opts: { id, name, color?, tags?, fields?, promptCaching?, isNew?, note? }
                if (!opts.id || !opts.name) return false;
                if (providers.find(p => p.id === opts.id)) return false;
                providers.push({
                    id: opts.id, name: opts.name, color: opts.color || 'primary',
                    tags: opts.tags || ['LLM'], fields: opts.fields || ['api_key'],
                    promptCaching: opts.promptCaching || false,
                    isNew: opts.isNew || false, note: opts.note || ''
                });
                renderProviders(); updateStats(); saveState(); syncConfig();
                emitEvent('addProvider', opts);
                toast(`Provider "${opts.name}" added`);
                return true;
            },
            removeProvider: (id) => {
                const idx = providers.findIndex(p => p.id === id);
                if (idx === -1) return false;
                providers.splice(idx, 1);
                delete state.providers[id];
                renderProviders(); updateStats(); saveState(); syncConfig();
                emitEvent('removeProvider', { id });
                toast(`Provider "${id}" removed`);
                return true;
            },
            enableProvider: (id, fieldValues) => {
                if (!state.providers[id]) state.providers[id] = { enabled: false, fields: {} };
                state.providers[id].enabled = true;
                if (fieldValues) state.providers[id].fields = { ...state.providers[id].fields, ...fieldValues };
                renderProviders(); updateStats(); saveState(); syncConfig();
                emitEvent('enableProvider', { id, fieldValues });
                return true;
            },
            disableProvider: (id) => {
                if (state.providers[id]) state.providers[id].enabled = false;
                renderProviders(); updateStats(); saveState(); syncConfig();
                emitEvent('disableProvider', { id });
                return true;
            },
            listProviders: () => providers.map(p => ({ ...p, enabled: state.providers[p.id]?.enabled || false })),

            // --- Channel CRUD ---
            addChannel: (opts) => {
                if (!opts.id || !opts.name) return false;
                if (channels.find(c => c.id === opts.id)) return false;
                channels.push({
                    id: opts.id, name: opts.name, icon: opts.icon || 'üîå',
                    description: opts.description || '', fields: opts.fields || [],
                    hasQrScan: opts.hasQrScan || false, alwaysEnabled: opts.alwaysEnabled || false,
                    isNew: opts.isNew || false, note: opts.note || ''
                });
                renderChannels(); updateStats(); saveState(); syncConfig();
                emitEvent('addChannel', opts);
                toast(`Channel "${opts.name}" added`);
                return true;
            },
            removeChannel: (id) => {
                const idx = channels.findIndex(c => c.id === id);
                if (idx === -1) return false;
                channels.splice(idx, 1);
                delete state.channels[id];
                renderChannels(); updateStats(); saveState(); syncConfig();
                emitEvent('removeChannel', { id });
                toast(`Channel "${id}" removed`);
                return true;
            },
            enableChannel: (id, fieldValues) => {
                if (!state.channels[id]) state.channels[id] = { enabled: false, fields: {} };
                state.channels[id].enabled = true;
                if (fieldValues) state.channels[id].fields = { ...state.channels[id].fields, ...fieldValues };
                renderChannels(); updateStats(); saveState(); syncConfig();
                emitEvent('enableChannel', { id, fieldValues });
                return true;
            },
            disableChannel: (id) => {
                if (state.channels[id]) state.channels[id].enabled = false;
                renderChannels(); updateStats(); saveState(); syncConfig();
                emitEvent('disableChannel', { id });
                return true;
            },
            listChannels: () => channels.map(c => ({ ...c, enabled: c.alwaysEnabled || state.channels[c.id]?.enabled || false })),

            // --- Tool CRUD ---
            addTool: (opts) => {
                if (!opts.id || !opts.name) return false;
                if (tools.find(t => t.id === opts.id)) return false;
                tools.push({
                    id: opts.id, name: opts.name, description: opts.description || '',
                    fields: opts.fields || [], hasButton: opts.hasButton || false, note: opts.note || ''
                });
                renderTools(); updateStats(); saveState(); syncConfig();
                emitEvent('addTool', opts);
                toast(`Tool "${opts.name}" added`);
                return true;
            },
            removeTool: (id) => {
                const idx = tools.findIndex(t => t.id === id);
                if (idx === -1) return false;
                tools.splice(idx, 1);
                delete state.tools[id];
                renderTools(); updateStats(); saveState(); syncConfig();
                emitEvent('removeTool', { id });
                toast(`Tool "${id}" removed`);
                return true;
            },
            enableTool: (id, fieldValues) => {
                if (!state.tools[id]) state.tools[id] = { enabled: false, fields: {} };
                state.tools[id].enabled = true;
                if (fieldValues) state.tools[id].fields = { ...state.tools[id].fields, ...fieldValues };
                renderTools(); updateStats(); saveState(); syncConfig();
                emitEvent('enableTool', { id, fieldValues });
                return true;
            },
            disableTool: (id) => {
                if (state.tools[id]) state.tools[id].enabled = false;
                renderTools(); updateStats(); saveState(); syncConfig();
                emitEvent('disableTool', { id });
                return true;
            },
            listTools: () => tools.map(t => ({ ...t, enabled: state.tools[t.id]?.enabled || false })),

            // --- Skill CRUD ---
            addSkill: (name, summary, content) => { addSkill(name, summary, content); },
            removeSkill: (nameOrIndex) => {
                const idx = typeof nameOrIndex === 'number' ? nameOrIndex : state.skills.findIndex(s => s.name === nameOrIndex);
                if (idx >= 0) removeSkill(idx);
            },
            listSkills: () => [...state.skills],

            // --- Cron CRUD ---
            addCronJob: (schedule, task) => { addCronJob(schedule, task); },
            removeCronJob: (idOrIndex) => {
                const idx = typeof idOrIndex === 'number' ? idOrIndex : state.cronJobs.findIndex(j => j.id === idOrIndex);
                if (idx >= 0) removeCronJob(idx);
            },
            listCronJobs: () => [...state.cronJobs],

            // --- MCP Server CRUD ---
            addMcpServer: (name, command, args, authHeader) => { addMcpServer(name, command, args, authHeader); },
            removeMcpServer: (nameOrIndex) => {
                const idx = typeof nameOrIndex === 'number' ? nameOrIndex : state.mcpServers.findIndex(s => s.name === nameOrIndex);
                if (idx >= 0) removeMcpServer(idx);
            },
            listMcpServers: () => [...state.mcpServers],

            // --- Subagent Management ---
            addSubagent: (name, task, maxIterations) => {
                state.subagents.push({ name, task, status: 'running', iteration: 0, maxIterations: maxIterations || 15 });
                renderSubagents(); saveState();
                emitEvent('addSubagent', { name, task });
                toast(`Subagent "${name}" spawned`);
            },
            updateSubagent: (name, updates) => {
                const sa = state.subagents.find(s => s.name === name);
                if (sa) { Object.assign(sa, updates); renderSubagents(); saveState(); }
            },
            removeSubagent: (name) => {
                state.subagents = state.subagents.filter(s => s.name !== name);
                renderSubagents(); saveState();
                emitEvent('removeSubagent', { name });
            },
            listSubagents: () => [...state.subagents],

            // --- Agent Config ---
            setAgentConfig: (key, value) => {
                state.agentConfig[key] = value;
                populateAgentConfigForm();
                syncConfig(); saveState();
                emitEvent('setAgentConfig', { key, value });
            },
            getAgentConfig: () => ({ ...state.agentConfig }),

            // --- Memory ---
            setMemory: (content) => {
                state.memory = content;
                const el = document.getElementById('memoryContent');
                if (el) el.value = content;
                saveState();
                emitEvent('setMemory', { content });
            },
            getMemory: () => state.memory,

            // --- Activity Log ---
            logActivity: (badge, badgeClass, message) => {
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                state.activityLog.unshift({ time, badge, badgeClass: badgeClass || 'badge-info', message });
                if (state.activityLog.length > 50) state.activityLog.pop();
                renderActivityFeed();
                saveState();
                emitEvent('logActivity', { badge, message });
            },

            // --- Custom Pages ---
            addPage: (pageId, title, html, navSection, navIcon) => {
                if (document.getElementById(pageId)) return false;
                // Create page div
                const contentArea = document.querySelector('.content-area');
                const pageDiv = document.createElement('div');
                pageDiv.id = pageId;
                pageDiv.className = 'page';
                pageDiv.innerHTML = html;
                contentArea.appendChild(pageDiv);
                // Register title
                pageTitles[pageId] = title;
                state.customPages[pageId] = { title, html };
                // Add nav item
                const nav = document.querySelector('.sidebar-nav');
                let section = nav.querySelector(`[data-section="${navSection || 'custom'}"]`);
                if (!section) {
                    section = document.createElement('div');
                    section.className = 'nav-section';
                    section.setAttribute('data-section', navSection || 'custom');
                    section.innerHTML = `<div class="nav-section-label">${navSection || 'Custom'}</div>`;
                    nav.appendChild(section);
                }
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.setAttribute('data-page', pageId);
                navItem.onclick = function() { navigate(pageId, this); };
                navItem.innerHTML = `<div class="nav-item-label"><span class="nav-item-icon">${navIcon || 'üìÑ'}</span><span>${title}</span></div>`;
                section.appendChild(navItem);
                saveState();
                emitEvent('addPage', { pageId, title });
                toast(`Page "${title}" added`);
                return true;
            },
            updatePage: (pageId, html) => {
                const page = document.getElementById(pageId);
                if (page && state.customPages[pageId]) {
                    page.innerHTML = html;
                    state.customPages[pageId].html = html;
                    saveState();
                    emitEvent('updatePage', { pageId });
                    return true;
                }
                return false;
            },
            removePage: (pageId) => {
                const page = document.getElementById(pageId);
                if (page) page.remove();
                const navItem = document.querySelector(`[data-page="${pageId}"]`);
                if (navItem) navItem.remove();
                delete pageTitles[pageId];
                delete state.customPages[pageId];
                saveState();
                emitEvent('removePage', { pageId });
                navigate('overview');
                return true;
            },

            // --- Navigation ---
            navigateTo: (pageId) => {
                navigate(pageId);
            },

            // --- Import/Export ---
            importConfig: (configObj) => { applyConfig(configObj); },
            exportConfig: () => buildConfig(),

            // --- Chat ---
            sendMessage: (text) => { sendChat(text); },

            // --- Toast ---
            toast: (msg) => { toast(msg); },

            // --- Full Reset ---
            reset: () => {
                localStorage.removeItem('nanobot-state');
                location.reload();
            },

            // --- Event Listener Helper ---
            on: (eventName, callback) => {
                window.addEventListener('nanobot:' + eventName, (e) => callback(e.detail));
            },

            // --- Version ---
            version: '0.1.4.post1'
        };
    </script>
</body>
</html>